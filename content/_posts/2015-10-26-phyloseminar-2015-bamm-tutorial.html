---
author: brianomeara_ra6153
comments: false
date: 2015-10-26 13:32:36+00:00
layout: post
link: http://www.brianomeara.info/2015/10/26/phyloseminar-2015-bamm-tutorial/
slug: phyloseminar-2015-bamm-tutorial
title: 'Phyloseminar 2015: BAMM tutorial'
wordpress_id: 383
categories:
- Phyloseminar
- Teaching
---



<p><a href="http://brianomeara.info/wordpress_beta/wp-content/uploads/2015/10/BAMM-Tutorial-Phyloseminar-2015.pdf">BAMM Tutorial Phyloseminar 2015.pdf</a></p>
<div id="bamm-tutorial-phyloseminar-2015" class="section level1">
<h1>BAMM Tutorial Phyloseminar 2015</h1>
<div id="orlando-schwery" class="section level4">
<h4><em><a href="https://sites.google.com/site/orlandoschwery/">Orlando Schwery</a></em></h4>
</div>
<div id="section" class="section level4">
<h4><em>2015-10-25</em></h4>
<p>This tutorial largely follows the tutorials by Dan Rabosky on <a href="www.BAMM-project.org">his website</a>.</p>
</div>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>BAMM consists of two components, the program that runs the actual analysis is in C++ (to be faster), while the analysis of the outputs happens in R.</p>
<div id="bamm" class="section level3">
<h3>BAMM</h3>
<p>Easiest might be to install it from the executables (both for Win and OS X), although from source and using homebrew is also possible.</p>
<ol style="list-style-type: decimal">
<li><p>Go to the <a href="http://bamm-project.org/download.html">Download-Page</a></p></li>
<li><p>download the appropriate BAMM version for your platform</p></li>
<li><p>download the zipped example files</p></li>
<li><p>unpack everything, in case of OS X, move to the appropriate directory in the command line and type</p></li>
</ol>
<pre><code>&lt;code&gt;tar -xzf bamm-2.3.0-MacOSX.tar.gz&lt;/code&gt;</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>move the files and folders to the directory you want</li>
</ol>
</div>
<div id="bammtools" class="section level3">
<h3>BAMMtools</h3>
<p>For this one, simply open R and type</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;install.packages&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&#39;BAMMtools&#39;&lt;/span&gt;)&lt;/code&gt;</code></pre>
<p>If it is installed, load the package using</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;library&lt;/span&gt;(BAMMtools)&lt;/code&gt;</code></pre>
</div>
</div>
<div id="run-bamm" class="section level2">
<h2>Run BAMM</h2>
<p>In order to run BAMM, we need nothing more than a <strong>tree</strong> and a <strong>controlfile</strong>. We will use the whale examples in this tutorial. To run your own analysis, it is a good idea to simply modify the example controlfile or use the <a href="http://bamm-project.org/_downloads/template_diversification.txt">template controlfile</a>.</p>
<p>Let’s start the whale analysis and then look at the controlfile.</p>
<div id="run-the-whales" class="section level3">
<h3>Run the Whales</h3>
<p>It is easiest to use BAMM when all files are in the same directory where BAMM is, so:</p>
<ol style="list-style-type: decimal">
<li><p>move the whale tree and the controlfile in the same folder as BAMM</p></li>
<li><p>to get a result that is looking a bit more realistic, we open the ‘divcontrol’ file and change <code>numberOfGenerations</code> from 10k to 1Mio</p></li>
<li><p>change the directory of your command line to that folder</p></li>
<li><p>start the analysis by typing:</p></li>
</ol>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;./bamm -c divcontrol.txt   &lt;span class=&quot;co&quot;&gt;# on windows you can omit the &#39;./&#39;&lt;/span&gt;&lt;/code&gt;</code></pre>
<ol start="5" style="list-style-type: decimal">
<li><p>wait for the MCMC to start running</p></li>
<li><p>the output files will be</p></li>
</ol>
<ul>
<li><p>chain_swap.txt</p></li>
<li><p>event_data.txt</p></li>
<li><p>mcmc_out.txt</p></li>
<li><p>prior_probs.txt</p></li>
<li><p>run_info.txt</p></li>
</ul>
<p>The main data we want to look at later is in the <strong>event_data</strong> file, and we look at the file <strong>mcmc_out</strong> to assess convergence. You might want to keep the <strong>run_info</strong> file with your other files in order to know what settings you used for a specific analysis.</p>
</div>
<div id="a-look-at-the-controlfile" class="section level3">
<h3>A look at the controlfile</h3>
<p>Go to the examples folder and find the ‘whales’ controlfile and tree in the ‘diversification’ subfolder. Open the controlfile ‘divcontrol.txt’. The file is pretty well annotated and most points should be fairly self-explanatory, we will quickly discuss some of them though.</p>
<p>Sections:</p>
<ul>
<li><p>General Setup and Data Input</p></li>
<li><p>Priors</p></li>
<li><p>MCMC Simulation Settings &amp; Output Options</p></li>
<li><p>Operators: MCMC Scaling Operators</p></li>
<li><p>Operators: MCMC Move Frequencies</p></li>
<li><p>Initial Parameter Values</p></li>
<li><p>Metropolis Coupled MCMC</p></li>
<li><p>Numerical and Other Parameters</p></li>
</ul>
<p>Most values are preset in a way that will work out well, and most users work along the policy to not touch anything if you don’t know what it does, but a few parameters are worth looking at (the bold ones you definitely have to modify for your own analysis, or at least consider it…):</p>
<ul>
<li><p>modeltype</p></li>
<li><p><strong>treefile</strong></p></li>
<li><p>useGlobalSamplingProbability</p></li>
<li><p><strong>globalSamplingFraction</strong></p></li>
<li><p>sampleProbsFilename</p></li>
<li><p><strong>all the priors…</strong></p></li>
<li><p><strong>numberOfGenerations</strong></p></li>
<li><p><strong>mcmcWriteFreq</strong></p></li>
<li><p><strong>eventDataWriteFreq</strong></p></li>
<li><p><strong>printFreq</strong></p></li>
<li><p><strong>acceptanceRateFreq</strong></p></li>
<li><p>scaling operators…</p></li>
<li><p>move frequencies…</p></li>
<li><p><strong>initial values…</strong></p></li>
<li><p>numberOfChains</p></li>
<li><p>deltaT</p></li>
<li><p>swapPeriod</p></li>
<li><p>minCladeSizeForShift</p></li>
<li><p>segLength</p></li>
</ul>
<p>More in-depth treatment of how to fine-tune the analysis and how to use advanced features can be found <a href="http://bamm-project.org/advanced.html">here</a></p>
</div>
</div>
<div id="analyse-outputs-with-bammtools" class="section level2">
<h2>Analyse outputs with BAMMtools</h2>
<p>Now we want to dig into the outputs of the analysis, which we do in R. There are a number of different options regarding what we can do and should do, and we try to look at the most important ones here.</p>
<div id="convergence" class="section level3">
<h3>Convergence</h3>
<p>Just like for any MCMC analyses, <em>e.g.</em> when we date a tree with BEAST, we want to know if we ran the analysis long enough to reach convergence. To do this for BAMM, we look at the file <strong>mcmc_out</strong> in R:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;mcmc &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;read.csv&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;/Users/orlandoschwery/Documents/UT/Courses/Fall 15/Phyloseminar/BAMMtutorial/mcmc_out.txt&quot;&lt;/span&gt;, &lt;span class=&quot;dt&quot;&gt;header=&lt;/span&gt;T)  &lt;span class=&quot;co&quot;&gt;# load file&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;dim&lt;/span&gt;(mcmc)  &lt;span class=&quot;co&quot;&gt;# check dimensions&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;head&lt;/span&gt;(mcmc)  &lt;span class=&quot;co&quot;&gt;# check head&lt;/span&gt;&lt;/code&gt;</code></pre>
<p>Now we can look at the trace plot of the log likelihood per generation (and if we want at the numbers of shifts per generation)</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;plot&lt;/span&gt;(mcmc$logLik ~&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;mcmc$generation)
&lt;span class=&quot;kw&quot;&gt;plot&lt;/span&gt;(mcmc$N_shifts ~&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;mcmc$generation)&lt;/code&gt;</code></pre>
<p>Now we want to discard a reasonable portion as burnin, <em>e.g.</em> 10%…</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;burnstart &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;floor&lt;/span&gt;(&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt; *&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;nrow&lt;/span&gt;(mcmc))
mcmcpost &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;mcmc[burnstart:&lt;span class=&quot;kw&quot;&gt;nrow&lt;/span&gt;(mcmc), ]&lt;/code&gt;</code></pre>
<p>… and calculate the effective sample size, which should exceed 200 if our analyses ran long enough (although different people might argue for different minimal values here).</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;library&lt;/span&gt;(coda)
&lt;span class=&quot;kw&quot;&gt;effectiveSize&lt;/span&gt;(mcmcpost$logLik)  &lt;span class=&quot;co&quot;&gt;# calculates autocorrelation function&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;effectiveSize&lt;/span&gt;(mcmcpost$N_shift)  &lt;span class=&quot;co&quot;&gt;# effective size on N_shifts&lt;/span&gt;
## do this on pre-burnin MCMC
&lt;span class=&quot;kw&quot;&gt;effectiveSize&lt;/span&gt;(mcmc$logLik)
&lt;span class=&quot;kw&quot;&gt;effectiveSize&lt;/span&gt;(mcmc$N_shift)&lt;/code&gt;</code></pre>
</div>
<div id="rate-shifts" class="section level3">
<h3>Rate Shifts</h3>
<p>Now for the thing we are most interested in: the rate shifts. We load the package BAMMtools, the tree we used and the event_data file, for which we specify the same burnin we decided on before:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;library&lt;/span&gt;(BAMMtools)
tree &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;read.tree&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;/Users/orlandoschwery/Documents/UT/Courses/Fall 15/Phyloseminar/BAMMtutorial/whaletree.tre&quot;&lt;/span&gt;)
ed &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;getEventData&lt;/span&gt;(tree, &lt;span class=&quot;st&quot;&gt;&quot;/Users/orlandoschwery/Documents/UT/Courses/Fall 15/Phyloseminar/BAMMtutorial/event_data.txt&quot;&lt;/span&gt;, &lt;span class=&quot;dt&quot;&gt;burnin=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;)&lt;/code&gt;</code></pre>
<p>It is possible to subset the event data file, if the size is too big for R to handle.</p>
<div id="phylorates-plots" class="section level4">
<h4>Phylorates Plots</h4>
<p>Now we can just look at the mean rates inferred:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;plot.bammdata&lt;/span&gt;(ed, &lt;span class=&quot;dt&quot;&gt;legend=&lt;/span&gt;T, &lt;span class=&quot;dt&quot;&gt;spex=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&#39;netdiv&#39;&lt;/span&gt;)&lt;/code&gt;</code></pre>
<p>We can also look at speciation or extinction rates separately:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;plot.bammdata&lt;/span&gt;(ed, &lt;span class=&quot;dt&quot;&gt;legend=&lt;/span&gt;T, &lt;span class=&quot;dt&quot;&gt;spex=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&#39;s&#39;&lt;/span&gt;)
&lt;span class=&quot;kw&quot;&gt;plot.bammdata&lt;/span&gt;(ed, &lt;span class=&quot;dt&quot;&gt;legend=&lt;/span&gt;T, &lt;span class=&quot;dt&quot;&gt;spex=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&#39;e&#39;&lt;/span&gt;)&lt;/code&gt;</code></pre>
<p>We can get a first idea on what number of shifts were most commonly found using summary (this just tells us how many samples contain a certain number of shifts, but not WHERE those shifts are):</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;&lt;span class=&quot;kw&quot;&gt;summary&lt;/span&gt;(ed)&lt;/code&gt;</code></pre>
</div>
<div id="bayes-factors-for-shift-models" class="section level4">
<h4>Bayes Factors for Shift Models</h4>
<p>To get a more robust idea of how certain shift models are performing compared to each other, we can calculate Bayes Factors:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;postfile &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;mcmc  &lt;span class=&quot;co&quot;&gt;# since we already loaded this&lt;/span&gt;
priorfile &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;read.csv&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;/Users/orlandoschwery/Documents/UT/Courses/Fall 15/Phyloseminar/BAMMtutorial/prior_probs.txt&quot;&lt;/span&gt;, &lt;span class=&quot;dt&quot;&gt;header=&lt;/span&gt;T)
bfmat &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;computeBayesFactors&lt;/span&gt;(postfile, priorfile, &lt;span class=&quot;dt&quot;&gt;burnin=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;0.1&lt;/span&gt;)&lt;/code&gt;</code></pre>
<p>The resulting table shows how models with certain numbers of shifts compare to a specific other one, BFs of &gt;20 indicate good support that a model is better than the one it is compared to, BFs of &gt;50 indicate very strong support.</p>
</div>
<div id="credible-shift-sets" class="section level4">
<h4>Credible Shift Sets</h4>
<p>What our data actually looks like now, are different samples of shift regimes, all of which are sampled at a certain frequency. We can access each of them, and it is a good idea to visualize the most frequent ones:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;pset &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;getBranchShiftPriors&lt;/span&gt;(tree, priorfile)
cset &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;credibleShiftSet&lt;/span&gt;(ed, pset, &lt;span class=&quot;dt&quot;&gt;BFcriterion=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)
&lt;span class=&quot;kw&quot;&gt;plot.credibleshiftset&lt;/span&gt;(cset, &lt;span class=&quot;dt&quot;&gt;lwd=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;2.5&lt;/span&gt;)&lt;/code&gt;</code></pre>
</div>
<div id="best-shift-set" class="section level4">
<h4>Best Shift Set</h4>
<p>Based on the credible shift sets, we might conclude that the most commonly sampled configuration of shifts is the best one:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;best &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;getBestShiftConfiguration&lt;/span&gt;(ed, &lt;span class=&quot;dt&quot;&gt;prior =&lt;/span&gt; pset)
&lt;span class=&quot;kw&quot;&gt;plot.bammdata&lt;/span&gt;(best, &lt;span class=&quot;dt&quot;&gt;lwd =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)
&lt;span class=&quot;kw&quot;&gt;addBAMMshifts&lt;/span&gt;(best, &lt;span class=&quot;dt&quot;&gt;cex=&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;2.5&lt;/span&gt;)&lt;/code&gt;</code></pre>
</div>
<div id="maximum-shift-credibility" class="section level4">
<h4>Maximum Shift Credibility</h4>
<p>Alternatively, pick the shiftset that maximizes the marginal likelihood of a shift on a branch, a set of maximum shift credibility, similar to when we get a maximum clade credibility tree out of a set of trees:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;msc.set &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;maximumShiftCredibility&lt;/span&gt;(ed, &lt;span class=&quot;dt&quot;&gt;maximize=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&#39;product&#39;&lt;/span&gt;)
msc.config &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;subsetEventData&lt;/span&gt;(ed, &lt;span class=&quot;dt&quot;&gt;index =&lt;/span&gt; msc.set$sampleindex)
&lt;span class=&quot;kw&quot;&gt;plot.bammdata&lt;/span&gt;(msc.config, &lt;span class=&quot;dt&quot;&gt;lwd=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)
&lt;span class=&quot;kw&quot;&gt;addBAMMshifts&lt;/span&gt;(msc.config, &lt;span class=&quot;dt&quot;&gt;cex =&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/code&gt;</code></pre>
</div>
</div>
<div id="macroevolutionary-cohort-analysis" class="section level3">
<h3>Macroevolutionary Cohort Analysis</h3>
<p>When we have rate shifts to lower or higher rates, some sampled configurations might cancel each other out ( <em>i.e.</em> some say speedup for sisterclade A, some say slowdown for sisterclade B). We can catch this (and more) by looking at the cohort matrix:</p>
<pre><code>&lt;code class=&quot;sourceCode r&quot;&gt;cmat &lt;-&lt;span class=&quot;st&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;getCohortMatrix&lt;/span&gt;(ed)
&lt;span class=&quot;kw&quot;&gt;cohorts&lt;/span&gt;(cmat, ed)&lt;/code&gt;</code></pre>
<p>Fin!</p>
</div>
</div>
</div>
