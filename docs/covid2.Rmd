---
author: Brian O'Meara
title: Local COVID data
---

Here are notes and links I personally find useful, all gathered in one place. Mostly, I kept looking at webcams to see whether people are practicing social distancing and decided to put them all in one page. I also gather data when nervous, so I also have plots of things like testing, activity, and cases over time so I can see the info directly myself (for example, <a href="https://covid.knoxcountytn.gov/case-count.html#covid_data">Knox County Health Department</a> plots cases per day with a trendline, but so far their trendline is only a straight line - I was curious if a more flexible fitting might be more informative). <b>I am not an epidemiologist</b>, so please do not draw any advice from this page (and I've been careful NOT to do projections or anything like that -- there is a lot that goes into modeling, see <a href="https://www.youtube.com/watch?v=Ewuo_2pzNNw">this video</a> by my colleague <a href="http://feffermanlab.org/">Nina Fefferman</a>, who unlike me is an expert in this, for more on models). This is just me poking around with the data to make myself feel better -- the raw code is <a href="https://github.com/bomeara/brianomearainfo/blob/master/docs/covid.Rmd">here</a> if you'd like to examine it yourself.

<hr />

Other sources for data and other information:

* <a href="https://www.utk.edu/coronavirus/">UTK coronavirus information</a>. See especially the <a href="https://chancellor.utk.edu/re-imagining-fall-task-force/report/">current task force report</a>.
* <a href="https://covid.knoxcountytn.gov/case-count.html#covid_data">Knox County data</a>. This also includes info about Knox's reopening plan and the benchmarks they're using
* <a href="https://insideofknoxville.com/">Inside of Knoxville</a> has reporting out of every health board meeting and other local news.
* <i><a href="https://www.knoxnews.com/news/">Knoxville News Sentinel</a></i> is our remaining local paper (though some of its staff have been furloughed) and it covers covid in Knoxville and Knox County.
* <a href="https://covid19-projections.com/us-tn">Projections for Tennessee</a>
* <a href="https://covidactnow.org/us/tn?s=49762">Covid ActNow aggregate</a> of information, including contact tracing, infection rate, and more
* <a href="https://nextstrain.org/ncov">COVID-19 phylogeny</a>. Family tree of the COVID-19 viruses around the world. This can be used by experts to understand how the disease has spread and is continuing to spread, as well as possible evolution during its spread.
* <a href="https://projects.propublica.org/reopening-america/">ProPublica's tracker of state status</a>. Click on the play button below their map to see how rates are changing over time, and dig into info on your state.
* <a href="https://www.tn.gov/health/cedep/ncov/data/downloadable-datasets.html">Tennessee Downloadable Datasets</a>
* <a href="https://sites.google.com/view/utk-covid19">Alex Zukowski's UTK dashboard</a>, including testing numbers that are available due to his work requesting them
* <a href="https://datastudio.google.com/u/0/reporting/9d4c8edd-0634-4dc4-a647-5de19183a437/page/IxOeB">Matthew Martin's UTK dashboard</a>
* <a href="https://healthdata.gov/dataset/covid-19-reported-patient-impact-and-hospital-capacity-facility">US HHS hospitalization by facility</a>

<hr />

And sections of my page:

* Info about <a href="#cases">cases</a> over time
* Info about <a href="#testing">testing</a> in the local area, including positivity rate
* Info potentially relevant about <a href="#schooling">schools</a>
* Info on <a href="#hospitalization">hospitalization</a> in the region, including data on availability of ventilators and ICU beds
* Info about <a href="#vaccination">vaccination</a> in the state
* Info about <a href="#demographics">demographics</a> of who is being diagnosed and who is dying from covid
* Info about <a href="#ages">ages</a> of the people getting positive tests (though the frequency with which people of differing age groups are being tested is not available)
* Info about cases at <a href="#ut">U. of Tennessee, Knoxville</a> (using public information only)
* <a href="#webcams">Webcams</a> showing activity at local sites, though not quite at the resolution to point to mask usage or not

The following plots are created in R using data from https://covid19datahub.io (Guidotti, E., Ardia, D., (2020), "COVID-19 Data Hub", Working paper, doi: 10.13140/RG.2.2.11649.81763), as well as information from Google and the <a href="https://www.tn.gov/health/cedep/ncov/data/downloadable-datasets.html">state of Tennessee dataset page</a> and plotting and analysis using the `forecast`, `ggplot2`, `reshape2`, and `dplyr` packages. Plots created on `r Sys.time()`. I use a seven day rolling average for most plots using the `geom_ma` function of `tidyquant`.

```{r data, echo=FALSE, message=FALSE, warning=FALSE}
library(COVID19)
library(forecast)
library(ggplot2)
library(reshape2)
library(dplyr)
library(readxl)
library(stringr)
library(anytime)
# devtools::install_github("mtna/rds-r", build_vignettes = TRUE)
library(rds.r)
library(ggrepel)
library(ggpubr)
library(lubridate)
library(tidyquant)
library(binom)
library(scales)
library(jsonlite)
library(gganimate)
options(timeout=600) # let things download for at least ten minutes
options(download.file.method = "libcurl")

#gmr <- "https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv"


counties_in_hospital_region <- c("Knox", "Anderson", "Roane", "Scott", "Blount", "Claiborne", "Jefferson", "Campbell", "Sevier", "Loudon", "Hamblen", "Cocke", "Monroe", "McMinn")

us <- COVID19::covid19(country="US", level=3, verbose=FALSE)
tn <- subset(us, administrative_area_level_2=="Tennessee")
knox <- subset(us, administrative_area_level_3=="Knox" & administrative_area_level_2=="Tennessee")
oakridge <- subset(us, administrative_area_level_3 %in% c("Roane", "Anderson") & administrative_area_level_2=="Tennessee")
region <-  subset(us, administrative_area_level_3 %in% counties_in_hospital_region & administrative_area_level_2=="Tennessee")
knox$percentconfirmed <- 100*knox$confirmed/knox$population

utk_testing_zukowski <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vRRoX-icFl5a6T5OVpSllMJ3QGVplgdDEKPHtuvEjcDKNEvw5X6dcgGYSMGmynFcdxUwH2u4kZjBTiT/pub?gid=1083850404&single=true&output=csv")
utk_testing_zukowski$Year <- 2020
year <- 2020
for (i in sequence(nrow(utk_testing_zukowski))) {
	if(grepl("Jan", utk_testing_zukowski$Date[i])) {
		year <- 2021 #so Jan and later going down get 2021
	}
	utk_testing_zukowski$Year[i] <- year
}
utk_testing_zukowski$Date <- lubridate::mdy(paste(utk_testing_zukowski$Date, utk_testing_zukowski$Year, sep=", "))

utk_reported_zukowski <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vRRoX-icFl5a6T5OVpSllMJ3QGVplgdDEKPHtuvEjcDKNEvw5X6dcgGYSMGmynFcdxUwH2u4kZjBTiT/pub?gid=1053792052&single=true&output=csv")

tn_aggregate <- tn %>% group_by(date) %>% summarise(confirmed = sum(confirmed), population=sum(population))
tn_aggregate$percentconfirmed <- 100*tn_aggregate$confirmed/tn_aggregate$population

tn_diff <- data.frame(date=tn_aggregate$date[-1], daily_confirmed=diff(tn_aggregate$confirmed), daily_percent_confirmed=diff(tn_aggregate$percentconfirmed))


us_aggregate <- us %>% group_by(date) %>% summarise(confirmed = sum(confirmed), population=sum(population))
us_aggregate$percentconfirmed <- 100*us_aggregate$confirmed/us_aggregate$population

oakridge_aggregate <- oakridge %>% group_by(date) %>% summarise(confirmed = sum(confirmed), population=sum(population))
oakridge_aggregate$percentconfirmed <- 100*oakridge_aggregate$confirmed/oakridge_aggregate$population

region_aggregate <- region %>% group_by(date) %>% summarise(confirmed = sum(confirmed), population=sum(population))
region_aggregate$percentconfirmed <- 100*region_aggregate$confirmed/region_aggregate$population

#us_diff <- data.frame(date=us_aggregate$date[-1], daily_confirmed=diff(us_aggregate$confirmed), daily_percent_confirmed=diff(tn_aggregate$percentconfirmed))



knox_diff <- data.frame(
  date=knox$date[-1],
  daily_confirmed=diff(knox$confirmed),
  daily_tested=diff(knox$tests),
  daily_recovered=diff(knox$recovered),
#  daily_workplace=diff(knox$workplaces_percent_change_from_baseline),
  #daily_retail_recreation=diff(knox$retail_and_recreation_percent_change_from_baseline),
#  daily_residential=diff(knox$residential_percent_change_from_baseline),
  daily_percent_confirmed = diff(knox$percentconfirmed)
)


knox_pop <- max(knox$population)
oakridge_pop <- max(oakridge_aggregate$population)
region_pop <- max(region_aggregate$population)

#
#
# knox_diff_last_three_weeks <- tail(knox_diff,21)
# knox_diff_last_three_weeks$daily_retail_recreation_2wk_lag <- head(tail(knox_diff$daily_retail_recreation, 21+14),21)



temp = tempfile(fileext = ".xlsx")
dataURL <- "https://www.tn.gov/content/dam/tn/health/documents/cedep/novel-coronavirus/datasets/Public-Dataset-County-New.XLSX"
download.file(dataURL, destfile=temp, mode='wb')

daily <- readxl::read_xlsx(temp, sheet =1, col_types=c("date", "text", rep("numeric",23)))

daily_knox <- subset(daily, COUNTY=="Knox") %>% select(-"COUNTY")
daily_knox$Region <- "Knox County"
daily_knox$Population <- knox_pop
daily_knox$New_cases_per_100k_per_week <- 100000*zoo::rollsum(daily_knox$NEW_CASES, k=7, align="right", fill=NA)/knox_pop
daily_knox$PositivityRate_per_week <- zoo::rollsum(daily_knox$NEW_POS_TESTS, k=7, align="right", fill=NA) / zoo::rollsum(daily_knox$NEW_TESTS, k=7, align="right", fill=NA)



daily_oakridge <- subset(daily, COUNTY %in% c("Roane", "Anderson")) %>% group_by(DATE) %>% select(-"COUNTY") %>% summarise_all(sum)
daily_oakridge$Region <- "Anderson + Roane"
daily_oakridge$Population <- oakridge_pop
daily_oakridge$New_cases_per_100k_per_week <- 100000*zoo::rollsum(daily_oakridge$NEW_CASES, k=7, align="right", fill=NA)/oakridge_pop
daily_oakridge$PositivityRate_per_week <- zoo::rollsum(daily_oakridge$NEW_POS_TESTS, k=7, align="right", fill=NA) / zoo::rollsum(daily_oakridge$NEW_TESTS, k=7, align="right", fill=NA)

#daily_oakridge$New_cases_per_100k <- 100000*(daily_oakridge$NEW_CASES/daily_oakridge$Population)



daily_region<- subset(daily, COUNTY %in% counties_in_hospital_region) %>% group_by(DATE) %>% select(-"COUNTY") %>% summarise_all(sum)

daily_region$Region <- "East TN"
daily_region$Population <- region_pop
daily_region$New_cases_per_100k_per_week <- 100000*zoo::rollsum(daily_region$NEW_CASES, k=7, align="right", fill=NA)/region_pop
daily_region$PositivityRate_per_week <- zoo::rollsum(daily_region$NEW_POS_TESTS, k=7, align="right", fill=NA) / zoo::rollsum(daily_region$NEW_TESTS, k=7, align="right", fill=NA)


daily_utk_testing_zukowski <- data.frame(DATE=utk_testing_zukowski$Date, TOTAL_CASES=utk_testing_zukowski$TESTS_POS_TOTAL, NEW_CASES=utk_testing_zukowski$TESTS_POS_NEW, TOTAL_CONFIRMED=utk_testing_zukowski$TESTS_POS_TOTAL, NEW_CONFIRMED=utk_testing_zukowski$TESTS_POS_NEW, POS_TESTS=utk_testing_zukowski$TESTS_POS_TOTAL, NEW_POS_TESTS=utk_testing_zukowski$TESTS_POS_NEW, NEG_TESTS=utk_testing_zukowski$TESTS_NEG_TOTAL, NEW_NEG_TESTS=utk_testing_zukowski$TESTS_NEG_NEW, TOTAL_TESTS=utk_testing_zukowski$TESTS_TOTAL, NEW_TESTS=utk_testing_zukowski$TESTS_NEW, Population=30000, Region="UTK Student Testing")

daily_utk_reported_zukowski <- data.frame(DATE=lubridate::ymd(utk_reported_zukowski$DATE), TOTAL_CASES=utk_reported_zukowski$CASES_TOTAL, NEW_CASES=utk_reported_zukowski$CASES_NEW, TOTAL_CONFIRMED=utk_reported_zukowski$CASES_TOTAL, NEW_CONFIRMED=utk_reported_zukowski$CASES_NEW,  TOTAL_ACTIVE=utk_reported_zukowski$CASES_ACTIVE, Population=30000, Region="UTK Reported")

#daily_focal <- dplyr::bind_rows(daily_knox, daily_oakridge, daily_region, daily_utk_testing_zukowski, daily_utk_reported_zukowski)

daily_focal <- dplyr::bind_rows(daily_knox, daily_oakridge, daily_region, daily_utk_testing_zukowski, daily_utk_reported_zukowski)

daily_focal$Tests_per_100k <- 100000*(daily_focal$NEW_TESTS/daily_focal$Population)
daily_focal$New_cases_per_100k <- 100000*(daily_focal$NEW_CASES/daily_focal$Population)
daily_focal$Active_cases_per_100k <- 100000*(daily_focal$TOTAL_ACTIVE/daily_focal$Population)
daily_focal$PositivityPercentage_per_week <- 100*daily_focal$PositivityRate_per_week



temp = tempfile(fileext = ".xlsx")
dataURL <- "https://www.tn.gov/content/dam/tn/health/documents/cedep/novel-coronavirus/datasets/Public-Dataset-Daily-County-Cases-5-18-Years.XLSX"
download.file(dataURL, destfile=temp, mode='wb')

schoolkids <- readxl::read_xlsx(temp, sheet =1, col_types=c("date", "text", rep("numeric",2)))

schoolkids_region<- subset(schoolkids, COUNTY %in% counties_in_hospital_region) %>% group_by(DATE) %>% select(-"COUNTY") %>% summarise_all(sum)

schoolkids_oakridge<- subset(schoolkids, COUNTY %in% c("Anderson", "Roane")) %>% group_by(DATE) %>% select(-"COUNTY") %>% summarise_all(sum)

schoolkids_knox<- subset(schoolkids, COUNTY %in% c("Knox")) %>% group_by(DATE) %>% select(-"COUNTY") %>% summarise_all(sum)

schoolkids_region$Region <- "East TN"
schoolkids_knox$Region <- "Knox County"
schoolkids_oakridge$Region <- "Anderson + Roane"
schoolkids_daily <- rbind(schoolkids_knox, schoolkids_oakridge, schoolkids_region)


hospital_knox_files <- list.files(path="/Users/bomeara/Dropbox/KnoxCovid", pattern="*covid_bed_capacity.csv", full.names=TRUE)
hospital_knox <- data.frame()
for (i in seq_along(hospital_knox_files)) {
  local_beds <- NA
  try(local_beds <- read.csv(hospital_knox_files[i]), silent=TRUE)
  if(!is.na(local_beds)) {
	local_beds$East.Region.Hospitals <- gsub('All Hospital Beds*', 'All Hospital Beds *', gsub('All Hospital Beds *', 'All Hospital Beds', local_beds$East.Region.Hospitals, fixed=TRUE), fixed=TRUE)
	local_beds$Total.Capacity <- as.numeric(gsub(",",'', local_beds$Total.Capacity))
	local_beds$Current.Census <- as.numeric(gsub(",",'', local_beds$Current.Census))
	local_beds$Current.Utilization <- as.numeric(gsub('%','', local_beds$Current.Utilization))
	local_beds$Available.Capacity <- as.numeric(gsub('%','', local_beds$Available.Capacity))
	local_beds$Date <- anytime::anytime(stringr::str_extract(hospital_knox_files[i], "\\d+_\\d+_\\d+_\\d+_\\d+_\\d+"))
	if (i==1) {
		hospital_knox <- local_beds
	} else {
		hospital_knox <- rbind(hospital_knox, local_beds)
	}
  }
}
hospital_knox <- subset(hospital_knox, East.Region.Hospitals != "Adult Floor Beds/Non-ICU")
hospital_knox <- hospital_knox[which(nchar(hospital_knox$East.Region.Hospitals)>0),]
hospital_knox$Current.Utilization[which(hospital_knox$Current.Utilization>100)] <- hospital_knox$Current.Utilization[which(hospital_knox$Current.Utilization>100)]/100 #to fix two days of data where Knox County was multiplying these by 100, getting 7935% utilization

hhs_sources <- jsonlite::fromJSON("https://healthdata.gov/data.json?page=0")
capacity_by_facility_number <- grep("COVID-19 Reported Patient Impact and Hospital Capacity by Facility", hhs_sources$dataset$title)


#capacity_by_facility_url <- hhs_sources$dataset$distribution[capacity_by_facility_number][[1]]$downloadURL #often a week behind though
temp = tempfile(fileext = ".csv")
#


scraped_url <- readLines("https://healthdata.gov/dataset/covid-19-reported-patient-impact-and-hospital-capacity-facility")
scraped_url <- scraped_url[grepl("https://healthdata.gov/sites/default/files/reported_hospital_capacity_admissions_facility_level_weekly_average_timeseries", scraped_url)]
capacity_by_facility_url <- str_extract(scraped_url, "https.*csv")


utils::download.file(capacity_by_facility_url, temp, method="libcurl")

hhs_capacity <- read.csv(file=temp)
hhs_capacity_tn <- subset(hhs_capacity, state=="TN")



# for(i in sequence(nrow(hhs_capacity_tn))) {
# 	for (j in sequence(ncol(hhs_capacity_tn))) {
# 		if(!is.na(hhs_capacity_tn[i,j])) {
# 			if(hhs_capacity_tn[i,j]==-999999) {
# 				hhs_capacity_tn[i,j] <- NA
# 			}
# 		}
# 	}
# }

# field info from https://healthdata.gov/covid-19-reported-patient-impact-and-hospital-capacity-facility-data-dictionary

# fields: 
# collection_week - This date indicates the start of the period of reporting (the starting Friday).
# state - [FAQ - 1. d)] The two digit state/territory code for the hospital.
# hospital_name - [FAQ - 1. a)] The name of the facility reporting.
# city - The city of the facility reporting.
# zip - The 5-digit zip code of the facility reporting.

# all_adult_hospital_inpatient_bed_occupied_7_day_avg - [FAQ - 4. b)] Average of total number of staffed inpatient adult beds that are occupied reported during the 7-day period.
# total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg - [FAQ - 9. a)] Average number of patients currently hospitalized in an adult inpatient bed who have laboratory-confirmed or suspected COVID19, including those in observation beds reported during the 7-day period.
# all_adult_hospital_inpatient_beds_7_day_avg - [FAQ - 3. b)] Average of total number of staffed inpatient adult beds in the hospital including all overflow and active surge/expansion beds used for inpatients (including all designated ICU beds) reported during the 7-day period.
# 
# total_staffed_adult_icu_beds_7_day_avg - [FAQ - 5. b)] Average of total number of staffed adult ICU beds reported in the 7-day period.
# staffed_adult_icu_bed_occupancy_7_day_avg - [FAQ - 6. b)] Average of total number of staffed inpatient adult ICU beds that are occupied reported in the 7-day period.
# staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg - [FAQ - 12. a)] Average number of patients currently hospitalized in a designated adult ICU bed who have suspected or laboratory-confirmed COVID-19 reported in the 7-day period.

# note that -999999 is apparently used for missing data

hhs_capacity_tn$percentage_adult_hospital_inpatient_bed_occupied_covid_confirmed_or_suspected_7_day_avg_of_all_occupied <- 100 * hhs_capacity_tn$total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg / hhs_capacity_tn$all_adult_hospital_inpatient_bed_occupied_7_day_avg

hhs_capacity_tn$percentage_adult_hospital_inpatient_bed_occupied_of_all_inpatient_beds <- 100 * hhs_capacity_tn$all_adult_hospital_inpatient_bed_occupied_7_day_avg / hhs_capacity_tn$all_adult_hospital_inpatient_beds_7_day_avg

hhs_capacity_tn$percentage_adult_hospital_inpatient_bed_unoccupied_of_all_inpatient_beds <- 100 - hhs_capacity_tn$percentage_adult_hospital_inpatient_bed_occupied_of_all_inpatient_beds

hhs_capacity_tn$number_unoccupied_adult_hospital_inpatient_beds <- hhs_capacity_tn$all_adult_hospital_inpatient_beds_7_day_avg - hhs_capacity_tn$all_adult_hospital_inpatient_bed_occupied_7_day_avg



hhs_capacity_tn$percentage_adult_hospital_ICU_bed_occupied_covid_confirmed_or_suspected_7_day_avg_of_all_ICU_occupied <- 100 * hhs_capacity_tn$staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg / hhs_capacity_tn$staffed_adult_icu_bed_occupancy_7_day_avg

hhs_capacity_tn$percentage_adult_hospital_inpatient_ICU_bed_occupied_of_all_inpatient_ICU_beds <- 100 * hhs_capacity_tn$staffed_adult_icu_bed_occupancy_7_day_avg / hhs_capacity_tn$total_staffed_adult_icu_beds_7_day_avg

hhs_capacity_tn$percentage_adult_hospital_inpatient_ICU_bed_unoccupied_of_all_inpatient_ICU_beds <- 100 - hhs_capacity_tn$percentage_adult_hospital_inpatient_ICU_bed_occupied_of_all_inpatient_ICU_beds

hhs_capacity_tn$number_unoccupied_adult_hospital_ICU_beds <- hhs_capacity_tn$total_staffed_adult_icu_beds_7_day_avg - hhs_capacity_tn$staffed_adult_icu_bed_occupancy_7_day_avg




focal_cities <- toupper(c("Oak Ridge", "Knoxville", "Lenoir City", "Maryville", "Sweetwater", "Harriman", "Powell", "Jefferson City", "Athens", "Morristown", "Sevierville", "Tazewell", "La Follette", "Jellico", "Sneedville", "Oneida"))
hhs_capacity_tn_focal <- hhs_capacity_tn[hhs_capacity_tn$city%in%focal_cities,]

hhs_capacity_tn_focal <- subset(hhs_capacity_tn_focal, 
	!is.na(all_adult_hospital_inpatient_bed_occupied_7_day_avg) & 
	!is.na(total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg) & 
	!is.na(all_adult_hospital_inpatient_beds_7_day_avg) &
	!is.na(total_staffed_adult_icu_beds_7_day_avg) &
	!is.na(staffed_adult_icu_bed_occupancy_7_day_avg) &
	!is.na(staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg) & 
	!is.na(percentage_adult_hospital_inpatient_bed_occupied_covid_confirmed_or_suspected_7_day_avg_of_all_occupied) &
	!is.na(percentage_adult_hospital_inpatient_bed_occupied_of_all_inpatient_beds) &
	!is.na(percentage_adult_hospital_ICU_bed_occupied_covid_confirmed_or_suspected_7_day_avg_of_all_ICU_occupied) &
	!is.na(percentage_adult_hospital_inpatient_ICU_bed_occupied_of_all_inpatient_ICU_beds)
)


hhs_capacity_tn_focal <- subset(hhs_capacity_tn_focal, 
	(all_adult_hospital_inpatient_bed_occupied_7_day_avg >= 0) & 
	(total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg >= 0) & 
	(all_adult_hospital_inpatient_beds_7_day_avg >= 0) &
	(total_staffed_adult_icu_beds_7_day_avg >= 0) &
	(staffed_adult_icu_bed_occupancy_7_day_avg >= 0) &
	(staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg >= 0)
)

#hhs_capacity_tn_focal <- subset(hhs_capacity_tn_focal, all_adult_hospital_inpatient_beds_7_day_avg>=100)

few_update_hospitals <- names(which(table(hhs_capacity_tn_focal$hospital_name)<=2))

if(length(few_update_hospitals)>0) {
	hhs_capacity_tn_focal <- subset(hhs_capacity_tn_focal, !(hospital_name %in% few_update_hospitals)) #deleting the tiny hospitals that don't update
}

hhs_capacity_tn_focal$hospital_name <- gsub("TENNOVA HEALTHCARE", "TENNOVA", hhs_capacity_tn_focal$hospital_name )
hhs_capacity_tn_focal$hospital_name <- stringr::str_to_title(hhs_capacity_tn_focal$hospital_name)
hhs_capacity_tn_focal$hospital_name[grepl("University Of Tn", hhs_capacity_tn_focal$hospital_name, ignore.case=TRUE)] <- "University of TN Medical Center"




hhs_capacity_tn_focal$DATE <- as.Date(hhs_capacity_tn_focal$collection_week)

hhs_capacity_tn_focal_cities <- hhs_capacity_tn_focal

hhs_capacity_tn_focal_cities <- hhs_capacity_tn_focal %>% group_by(city, DATE) %>% summarize_at(vars(number_unoccupied_adult_hospital_inpatient_beds, number_unoccupied_adult_hospital_ICU_beds), list(sum = ~sum(., na.rm=TRUE)))

combinations <- expand.grid(DATE = unique(hhs_capacity_tn_focal_cities$DATE), city = unique(hhs_capacity_tn_focal_cities$city))

hhs_capacity_tn_focal_cities <- full_join(hhs_capacity_tn_focal_cities, combinations, by = c("DATE" = "DATE", "city" = "city")) %>% mutate(number_unoccupied_adult_hospital_inpatient_beds_sum = ifelse(is.na(number_unoccupied_adult_hospital_inpatient_beds_sum), 0, number_unoccupied_adult_hospital_inpatient_beds_sum)) %>% mutate(number_unoccupied_adult_hospital_ICU_beds_sum = ifelse(is.na(number_unoccupied_adult_hospital_ICU_beds_sum), 0, number_unoccupied_adult_hospital_ICU_beds_sum))

hhs_capacity_tn_focal_cities$city <- stringr::str_to_title(hhs_capacity_tn_focal_cities$city)

hhs_capacity_tn_focal_latest <- subset(hhs_capacity_tn_focal, DATE==max(DATE))
hhs_capacity_tn_focal_latest <- hhs_capacity_tn_focal_latest[order(hhs_capacity_tn_focal_latest$all_adult_hospital_inpatient_beds_7_day_avg, decreasing=TRUE),]
hhs_capacity_tn_focal_latest_pretty <- hhs_capacity_tn_focal_latest[,c(
	"hospital_name", 
	"city", 
	"all_adult_hospital_inpatient_beds_7_day_avg", 
	"number_unoccupied_adult_hospital_inpatient_beds", 
	"percentage_adult_hospital_inpatient_bed_unoccupied_of_all_inpatient_beds", 
	"total_staffed_adult_icu_beds_7_day_avg", 
	"number_unoccupied_adult_hospital_ICU_beds", 
	"percentage_adult_hospital_inpatient_ICU_bed_unoccupied_of_all_inpatient_ICU_beds"
)]
colnames(hhs_capacity_tn_focal_latest_pretty) <- c(
	"Hospital", 
	"City", 
	"Adult beds total", 
	"Adult beds number avail", 
	"Adult beds % avail", 
	"Adult ICU total", 
	"Adult ICU number avail", 
	"Adult ICU % avail"
)

for (i in 3:ncol(hhs_capacity_tn_focal_latest_pretty)) {
	hhs_capacity_tn_focal_latest_pretty[,i]<- round(hhs_capacity_tn_focal_latest_pretty[,i])
}

hhs_capacity_tn_focal_latest_pretty$City <- stringr::str_to_title(hhs_capacity_tn_focal_latest_pretty$City)
rownames(hhs_capacity_tn_focal_latest_pretty) <- NULL

# data from US census

population_total <- 6829174

population_female <- population_total*0.512
population_male <- population_total*(1-0.512)

population_white <- population_total*0.784
population_black_africanamerican <- population_total*0.171
population_asian <- population_total*0.02
population_americanindian_alaskannative <- population_total*0.005
population_nativehawaiian_other_pacificislander <- population_total*0.001
population_twoormoreraces <- population_total*0.02

population_hispanic <- population_total*0.057
population_not_hispanic <- population_total*(1-0.057)


population_age_under_5 <- population_total*0.06
population_age_under_18 <- population_total*0.221
population_age_65_and_over <- population_total*0.167



temp = tempfile(fileext = ".xlsx")
dataURL <- "https://www.tn.gov/content/dam/tn/health/documents/cedep/novel-coronavirus/datasets/COVID_VACCINE_DEMOGRAPHICS.XLSX"
download.file(dataURL, destfile=temp, mode='wb')
demographics_vaccine <- readxl::read_xlsx(temp, sheet =1)
demographics_vaccine$RECIPIENT_COUNT[is.na(demographics_vaccine$RECIPIENT_COUNT)] <- demographics_vaccine$VACCINE_COUNT[is.na(demographics_vaccine$RECIPIENT_COUNT)]
demographics_vaccine$RECIP_FULLY_VACC[is.na(demographics_vaccine$RECIP_FULLY_VACC)] <- 0





race_vaccine <- subset(demographics_vaccine, CATEGORY=="RACE")
race_vaccine$Race <- stringr::str_to_title(race_vaccine$CAT_DETAIL)

ethnicity_vaccine <- subset(demographics_vaccine, CATEGORY=="ETHN")
ethnicity_vaccine$Ethnicity <- stringr::str_to_title(ethnicity_vaccine$CAT_DETAIL)

sex_vaccine <- subset(demographics_vaccine, CATEGORY=="SEX")
sex_vaccine$Sex <- stringr::str_to_title(sex_vaccine$CAT_DETAIL)
sex_vaccine$Sex <- gsub("F", "Female", sex_vaccine$Sex)
sex_vaccine$Sex <- gsub("M", "Male", sex_vaccine$Sex)
sex_vaccine$Sex <- gsub("U", "Unknown", sex_vaccine$Sex)
sex_vaccine$Sex <- gsub("O", "Other", sex_vaccine$Sex)




temp = tempfile(fileext = ".xlsx")
dataURL <- "https://www.tn.gov/content/dam/tn/health/documents/cedep/novel-coronavirus/datasets/Public-Dataset-RaceEthSex.XLSX"
download.file(dataURL, destfile=temp, mode='wb')
demographics <- readxl::read_xlsx(temp, sheet =1)
demographics$percent_of_demographic_with_cases <- 0
demographics$percent_of_demographic_dead <- 0
demographics <- subset(demographics, as.character(demographics$Date)!="2020-07-28") #there was an error that day for Native Hawaiian or Other Pacific Islander: it went from 2 to 15 recorded deaths. Remove date from all data just to be safe.



race <- subset(demographics, Category=="RACE")
race <- subset(race, CAT_DETAIL != "Pending")


race[which(race$CAT_DETAIL=="White"),]$percent_of_demographic_with_cases <- 100*race[which(race$CAT_DETAIL=="White"),]$Cat_CaseCount/population_white
race[which(race$CAT_DETAIL=="White"),]$percent_of_demographic_dead <- 100*race[which(race$CAT_DETAIL=="White"),]$CAT_DEATHCOUNT/population_white
race[which(race$CAT_DETAIL=="Black or African American"),]$percent_of_demographic_with_cases <- 100*race[which(race$CAT_DETAIL=="Black or African American"),]$Cat_CaseCount/population_black_africanamerican
race[which(race$CAT_DETAIL=="Black or African American"),]$percent_of_demographic_dead <- 100*race[which(race$CAT_DETAIL=="Black or African American"),]$CAT_DEATHCOUNT/population_black_africanamerican
race[which(race$CAT_DETAIL=="Asian"),]$percent_of_demographic_with_cases <- 100*race[which(race$CAT_DETAIL=="Asian"),]$Cat_CaseCount/population_asian
race[which(race$CAT_DETAIL=="Asian"),]$percent_of_demographic_dead <- 100*race[which(race$CAT_DETAIL=="Asian"),]$CAT_DEATHCOUNT/population_asian
race[which(race$CAT_DETAIL=="American Indian or Alaska Native"),]$percent_of_demographic_with_cases <- 100*race[which(race$CAT_DETAIL=="American Indian or Alaska Native"),]$Cat_CaseCount/population_americanindian_alaskannative
race[which(race$CAT_DETAIL=="American Indian or Alaska Native"),]$percent_of_demographic_dead <- 100*race[which(race$CAT_DETAIL=="American Indian or Alaska Native"),]$CAT_DEATHCOUNT/population_americanindian_alaskannative
race[which(race$CAT_DETAIL=="Native Hawaiian or Other Pacific Islander"),]$percent_of_demographic_with_cases <- 100*race[which(race$CAT_DETAIL=="Native Hawaiian or Other Pacific Islander"),]$Cat_CaseCount/population_nativehawaiian_other_pacificislander
race[which(race$CAT_DETAIL=="Native Hawaiian or Other Pacific Islander"),]$percent_of_demographic_dead <- 100*race[which(race$CAT_DETAIL=="Native Hawaiian or Other Pacific Islander"),]$CAT_DEATHCOUNT/population_nativehawaiian_other_pacificislander
race[which(race$CAT_DETAIL=="Other/Multiracial"),]$percent_of_demographic_with_cases <- 100*race[which(race$CAT_DETAIL=="Other/Multiracial"),]$Cat_CaseCount/population_twoormoreraces
race[which(race$CAT_DETAIL=="Other/Multiracial"),]$percent_of_demographic_dead <- 100*race[which(race$CAT_DETAIL=="Other/Multiracial"),]$CAT_DEATHCOUNT/population_twoormoreraces
race <- subset(race, CAT_DETAIL!="Other/Multiracial") # see note above
race <- subset(race, CAT_DETAIL!="Other/ Multiracial") # see note above

race$Race <- race$CAT_DETAIL


ethnicity <- subset(demographics, Category=="ETHNICITY")
ethnicity <- subset(ethnicity, CAT_DETAIL != "Pending")

ethnicity[which(ethnicity$CAT_DETAIL=="Hispanic"),]$percent_of_demographic_with_cases <- 100*ethnicity[which(ethnicity$CAT_DETAIL=="Hispanic"),]$Cat_CaseCount/population_hispanic
ethnicity[which(ethnicity$CAT_DETAIL=="Hispanic"),]$percent_of_demographic_dead <- 100*ethnicity[which(ethnicity$CAT_DETAIL=="Hispanic"),]$CAT_DEATHCOUNT/population_hispanic


ethnicity[which(ethnicity$CAT_DETAIL=="Not Hispanic or Latino"),]$percent_of_demographic_with_cases <- 100*ethnicity[which(ethnicity$CAT_DETAIL=="Not Hispanic or Latino"),]$Cat_CaseCount/population_not_hispanic
ethnicity[which(ethnicity$CAT_DETAIL=="Not Hispanic or Latino"),]$percent_of_demographic_dead <- 100*ethnicity[which(ethnicity$CAT_DETAIL=="Not Hispanic or Latino"),]$CAT_DEATHCOUNT/population_not_hispanic
ethnicity$Ethnicity <- ethnicity$CAT_DETAIL



sex <- subset(demographics, Category=="SEX")
sex <- subset(sex, CAT_DETAIL != "Pending")


sex[which(sex$CAT_DETAIL=="Female"),]$percent_of_demographic_with_cases <- 100*sex[which(sex$CAT_DETAIL=="Female"),]$Cat_CaseCount/population_female
sex[which(sex$CAT_DETAIL=="Female"),]$percent_of_demographic_dead <- 100*sex[which(sex$CAT_DETAIL=="Female"),]$CAT_DEATHCOUNT/population_female

sex[which(sex$CAT_DETAIL=="Male"),]$percent_of_demographic_with_cases <- 100*sex[which(sex$CAT_DETAIL=="Male"),]$Cat_CaseCount/population_male
sex[which(sex$CAT_DETAIL=="Male"),]$percent_of_demographic_dead <- 100*sex[which(sex$CAT_DETAIL=="Male"),]$CAT_DEATHCOUNT/population_male
sex$Sex <- sex$CAT_DETAIL


temp = tempfile(fileext = ".xlsx")
dataURL <- "https://www.tn.gov/content/dam/tn/health/documents/cedep/novel-coronavirus/datasets/Public-Dataset-Daily-County-Age-Group.XLSX"
download.file(dataURL, destfile=temp, mode='wb')

age_county <- readxl::read_xlsx(temp, sheet =1)
age_county <- subset(age_county, AGE_GROUP != "Pending")

age_county$AGE_GROUP_SIMPLE <- age_county$AGE_GROUP
age_county$AGE_GROUP_SIMPLE <- gsub("71-80 years", "71+ years", age_county$AGE_GROUP_SIMPLE)
age_county$AGE_GROUP_SIMPLE <- gsub("81\\+ years", "71+ years", age_county$AGE_GROUP_SIMPLE)
age_county %<>% group_by(COUNTY, AGE_GROUP_SIMPLE, DATE) %>% mutate(SUM_CASE_COUNT = sum(CASE_COUNT))
age_county <- subset(age_county, AGE_GROUP != "81+ years") #get rid of pruned
age_county <- data.frame(DATE=age_county$DATE, COUNTY=age_county$COUNTY, AGE_GROUP = age_county$AGE_GROUP_SIMPLE, CASE_COUNT=age_county$SUM_CASE_COUNT)

age_county %<>% group_by(COUNTY, AGE_GROUP) %>% mutate(Difference=CASE_COUNT - lag(CASE_COUNT))
age_county %<>% group_by(COUNTY, DATE) %>% mutate(PercentDaily=100*Difference/sum(Difference), PercentCumulative=100*CASE_COUNT/sum(CASE_COUNT))

webfiles <- list.files(path="/Users/bomeara/Dropbox/UTKCovid", pattern="*html", full.names =TRUE)
utk.cases <- data.frame()
for(i in seq_along(webfiles)) {
  raw <- paste0(readLines(webfiles[i]),collapse=" ")
  raw <- gsub('\\x3c', '', raw, fixed=TRUE)
  raw <- gsub('\\x3d', '', raw, fixed=TRUE)
  raw <- gsub('\\x3e', '', raw, fixed=TRUE)
  raw <- gsub('/span/tdtd style\"width: \\d+\\.*\\d*%;\"span style\"font-size: 18px;\"', '', raw, fixed=FALSE)
  raw <- gsub('/span/tdtd style\"width: \\d+\\.*\\d*%; text-align: left;\"span style\"font-size: 18px;\"', '', raw, fixed=FALSE)
  students <- as.numeric(gsub("Students", "", stringr::str_extract(raw, "Students\\d+")))
    faculty <- as.numeric(gsub("Faculty", "", stringr::str_extract(raw, "Faculty\\d+")))
    staff <- as.numeric(gsub("Staff", "", stringr::str_extract(raw, "Staff\\d+")))
  actual_time <- anytime::anytime(stringr::str_extract(webfiles[i], "\\d+_\\d+_\\d+_\\d+_\\d+_\\d+"))
  result <- data.frame(date=rep(actual_time, 3), count=c(students, faculty, staff), group=c("students", "faculty", "staff"))
  if(i==1) {
    utk.cases <- result
  } else {
    utk.cases <- rbind(utk.cases, result)
  }
}
utk.cases$group <- as.factor(utk.cases$group)

saliva_data <- read.csv(file="7 LIVE_saliva_test_data_Page 1_Table.csv", stringsAsFactors=FALSE)
saliva_data2 <- read.csv(file="LIVE spring 2021 saliva table_Page 1_Table.csv", stringsAsFactors=FALSE)
saliva_data2 <- subset(saliva_data2, Category=="Residents")
saliva_data2$Locations <- "Residents"
saliva_data2$Week <- saliva_data2$Week.ending
saliva_data2$Positive.diagnostic.tests. <- saliva_data2$Positive.diagnostic.tests
saliva_data2$Positive.pools <- saliva_data2$Number.of.positive.pools

saliva_data2$Participation.rate <- as.numeric(gsub('%', '', saliva_data2$Participation.rate))/100
saliva_data <- plyr::rbind.fill(saliva_data, saliva_data2)

saliva_data$Active_cases_per_100k = 100000*saliva_data$Positive.diagnostic.tests./saliva_data$Samples
saliva_data$Active_cases_per_30k = 30000*saliva_data$Positive.diagnostic.tests./saliva_data$Samples
saliva_data$New_cases_per_100k = saliva_data$Active_cases_per_100k / 14
#saliva_data$DATE <- as.Date(saliva_data$Week,"%m/%d/%y")
saliva_data$DATE <- as.Date(saliva_data$Week,"%b %d, %Y")
#saliva_data$DATE <- as.Date(saliva_data$Week,"%d-%m-%y")

saliva_data$New_cases_per_100k_lower <- 100000*binom::binom.confint(saliva_data$Positive.diagnostic.tests., saliva_data$Samples, method="exact")$lower/14
saliva_data$New_cases_per_100k_upper<- 100000*binom::binom.confint(saliva_data$Positive.diagnostic.tests., saliva_data$Samples, method="exact")$upper/14


daily_utk <- subset(daily_focal, Region=="UTK Student Testing")
daily_utk$DATE <- as.Date(daily_utk$DATE)
utk_official_testing <- read.csv(file="8 LIVE_SHC_test_data_Page 1_Table.csv", stringsAsFactors=FALSE)
utk_official_testing$DATE <- as.Date(utk_official_testing$Week,"%b %d, %Y")
utk_official_testing$NEW_TESTS <- utk_official_testing$Total/7
utk_official_testing$DailyNegative <- utk_official_testing$Negative.tests/7
utk_official_testing$NEW_CONFIRMED <- utk_official_testing$Positive.tests/7
real_rows <- nrow(utk_official_testing)
for (i in 1:6) {
	next_day <- utk_official_testing[1:real_rows,]
	next_day$DATE <- next_day$DATE+i
	utk_official_testing <- rbind(utk_official_testing, next_day)
}

daily_utk$Data_source <- "UTK Zukowski release"
utk_official_testing$Data_source <- "UTK weekly release"
daily_utk <- plyr::rbind.fill(daily_utk, utk_official_testing)
daily_utk <- daily_utk[order(daily_utk$DATE), ]

daily_utk$NEW_PROPORTION_CONFIRMED <- 100*daily_utk$NEW_CONFIRMED/daily_utk$NEW_TESTS

daily_focal_no_ut <- daily_focal[!grepl("UTK", daily_focal$Region), ]

```

<h2 id="cases">Cases</h2>

The number of new should be not be going up if things are well-controlled, and ideally should be going down. I used to plot active cases, but how those are tracked has changed (it used to be based on recoveries, now it's just a two weeek lag of active). This uses data from https://www.tn.gov/health/cedep/ncov/data/downloadable-datasets.html. The number of new cases per day seems to align fairly well, but not perfectly, between the state and county data.

I plot five regions (though for simplicity, for some of the plots I omit East TN, and regions with no data automatically do not get plotted for certain measures)

* Knox County (which includes Knoxville)
* Anderson & Roane Counties, which include the town of Oak Ridge
* East TN (the `r length(counties_in_hospital_region)` counties that have acute care hospitals in Knox County/East Region according to Knox County)
* UTK Student Testing, from tests done at the UTK student health center
* UTK Reported, from all cases UT includes on their dashboard (student cases from the health center, cases reported from tests off campus that are communicated)

Information from the last two datasets comes from the hard work of Alex Zukowski, who requests the testing data and who aggregates the reported data. Zukowski, Taylor A. “University of Tennessee, Knoxville COVID-19 Dataset.” COVID-19 in The University of Tennessee, Knoxville, 2020, sites.[google.com/view/utk-covid19/data](google.com/view/utk-covid19/data). I recommend going to [https://sites.google.com/view/utk-covid19](https://sites.google.com/view/utk-covid19) for more on this dataset and the work going into gathering it.

For many of these plots, I am now showing the seven day averages.

```{r plots_cdc, echo=FALSE, message=FALSE, warning=FALSE}
daily_focal_no_ut_cleaned <- daily_focal_no_ut[!is.na(daily_focal_no_ut$New_cases_per_100k_per_week),]
daily_focal_no_ut_cleaned <- daily_focal_no_ut_cleaned[!is.na(daily_focal_no_ut_cleaned$PositivityPercentage_per_week),]
local_cdc <- 


local_cdc <- ggplot(daily_focal_no_ut_cleaned, aes(x=PositivityPercentage_per_week, y=New_cases_per_100k_per_week, group=Region)) + geom_line(aes(colour=Region)) + ylab("Number of new cases in area each week per 100,000 people") + xlab("Percentage of positive tests per week") + 
annotate(geom="rect", xmin=0, xmax=5, ymin=-50, ymax=max(daily_focal_no_ut_cleaned$New_cases_per_100k_per_week), alpha=0.1, fill="blue") +
annotate(geom="rect", xmin=5, xmax=7.95, ymin=-50, ymax=max(daily_focal_no_ut_cleaned$New_cases_per_100k_per_week), alpha=0.1, fill="yellow") +
annotate(geom="rect", xmin=7.95, xmax=9.95, ymin=-50, ymax=max(daily_focal_no_ut_cleaned$New_cases_per_100k_per_week), alpha=0.1, fill="orange") +
annotate(geom="rect", xmin=9.95, xmax=max(daily_focal_no_ut_cleaned$PositivityPercentage_per_week), ymin=-50, ymax=max(daily_focal_no_ut_cleaned$New_cases_per_100k_per_week), alpha=0.1, fill="red")  +
annotate(geom="rect", xmin=-1, xmax=max(daily_focal_no_ut_cleaned$PositivityPercentage_per_week), ymin=0, ymax=9.5, alpha=0.1, fill="blue") +
annotate(geom="rect", xmin=-1, xmax=max(daily_focal_no_ut_cleaned$PositivityPercentage_per_week), ymin=9.5, ymax=49.5, alpha=0.1, fill="yellow") +
annotate(geom="rect", xmin=-1, xmax=max(daily_focal_no_ut_cleaned$PositivityPercentage_per_week), ymin=49.5, ymax=99.5, alpha=0.1, fill="orange") +
annotate(geom="rect", xmin=-1, xmax=max(daily_focal_no_ut_cleaned$PositivityPercentage_per_week), ymin=99.5, ymax=max(daily_focal_no_ut_cleaned$New_cases_per_100k_per_week), alpha=0.1, fill="red") 
print(local_cdc)

```

```{r plotsA, echo=FALSE, message=FALSE, warning=FALSE}

local_new <- ggplot(daily_focal_no_ut[!is.na(daily_focal_no_ut$NEW_CASES),], aes(x=DATE, y=NEW_CASES, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE)  + ylab("Number of new cases in area each day") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
print(local_new)

#local_active <- ggplot(daily_focal[!is.na(daily_focal$TOTAL_ACTIVE),], aes(x=DATE, y=TOTAL_ACTIVE, group=Region)) +  geom_smooth(aes(colour=Region), se=FALSE) + geom_point(aes(colour=Region), size=0.5) + ylab("Number of active cases in area each day") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
#local_active <- ggplot(daily_focal[!is.na(daily_focal$TOTAL_ACTIVE),], aes(x=DATE, y=TOTAL_ACTIVE, group=Region)) +  geom_line(aes(colour=Region)) + geom_point(aes(colour=Region), size=0.5) + ylab("Number of active cases in area each day") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
#print(local_active)


```



```{r plotsA2, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}


#local_new_100k <- ggplot(daily_focal[!is.na(daily_focal$New_cases_per_100k),], aes(x=DATE, y=New_cases_per_100k, group=Region)) + geom_smooth(aes(colour=Region), se=FALSE) + geom_point(aes(colour=Region), size=0.5)  + ylab("Number of new cases in area each day per 100,000 people") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
local_new_100k <- ggplot(daily_focal_no_ut[!is.na(daily_focal_no_ut$New_cases_per_100k),], aes(x=DATE, y=New_cases_per_100k, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE)  + ylab("Number of new cases in area each day per 100,000 people") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
print(local_new_100k)

#local_active_100k <- ggplot(daily_focal[!is.na(daily_focal$Active_cases_per_100k),], aes(x=DATE, y=Active_cases_per_100k, group=Region)) +  geom_smooth(aes(colour=Region), se=FALSE) + geom_point(aes(colour=Region), size=0.5) + ylab("Number of active cases in area each day per 100,000 residents") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
#local_active_100k <- ggplot(daily_focal[!is.na(daily_focal$Active_cases_per_100k),], aes(x=DATE, y=Active_cases_per_100k, group=Region)) +  geom_line(aes(colour=Region)) + geom_point(aes(colour=Region), size=0.5) + ylab("Number of active cases in area each day per 100,000 residents") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
#print(local_active_100k)


```

Here are the same plots, but normalized so it's per 100,000 people in each area per day (making it easier to see patterns in less populous areas). I here use the [Harvard Global Health Institute's](https://globalepidemics.org/key-metrics-for-covid-suppression/) standards for guidance of control. Yellow means "rigorous test and trace programs advised", orange means "stay-at-home orders and/or rigorous test and trace programs advised", and red means "stay-at-home orders necessary".

```{r newcasesharvard, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
#daily_focal_away_from_zero <- subset(daily_focal_no_ut, New_cases_per_100k>0.5) #to keep the plot from blowing up towards zero
local_new_100k_harvard <- ggplot(daily_focal_no_ut[!is.na(daily_focal_no_ut$New_cases_per_100k),], aes(x=DATE, y=New_cases_per_100k, group=Region)) + 
geom_rect(mapping=aes(xmin=min(daily_focal_no_ut$DATE), xmax=max(daily_focal_no_ut$DATE), ymin=0, ymax=1), fill="darkolivegreen1") +
  geom_rect(mapping=aes(xmin=min(daily_focal_no_ut$DATE), xmax=max(daily_focal_no_ut$DATE), ymin=1, ymax=10), fill="khaki1") +
  geom_rect(mapping=aes(xmin=min(daily_focal_no_ut$DATE), xmax=max(daily_focal_no_ut$DATE), ymin=10, ymax=25), fill="tan1") +
  geom_rect(mapping=aes(xmin=min(daily_focal_no_ut$DATE), xmax=max(daily_focal_no_ut$DATE), ymin=25, ymax=35), fill="indianred1") + 
geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Number of new cases in area each day per 100,000 people") + xlab("Date") + ylim(0,35) + scale_colour_viridis_d(end=0.8) 
# daily_focal_away_from_zero <- daily_focal_no_ut
# local_new_100k_log1p <- ggplot(daily_focal_away_from_zero[!is.na(daily_focal_away_from_zero$New_cases_per_100k),], aes(x=DATE, y=New_cases_per_100k, group=Region)) + 
# geom_rect(mapping=aes(xmin=min(daily_focal_away_from_zero$DATE), xmax=max(daily_focal_away_from_zero$DATE), ymin=0, ymax=1), fill="darkolivegreen1") +
#   geom_rect(mapping=aes(xmin=min(daily_focal_away_from_zero$DATE), xmax=max(daily_focal_away_from_zero$DATE), ymin=1, ymax=10), fill="khaki1") +
#   geom_rect(mapping=aes(xmin=min(daily_focal_away_from_zero$DATE), xmax=max(daily_focal_away_from_zero$DATE), ymin=10, ymax=25), fill="tan1") +
#   geom_rect(mapping=aes(xmin=min(daily_focal_away_from_zero$DATE), xmax=max(daily_focal_away_from_zero$DATE), ymin=25, ymax=40), fill="indianred1") + 
# geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Number of new cases in area each day per 100,000 people") + xlab("Date") + ylim(0,40) + scale_colour_viridis_d(end=0.8) 
#+ scale_y_continuous(trans = "log1p", breaks = c(1, 10, 25))
print(local_new_100k_harvard)
```

```{r greenzone, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# Knox County has published <a href="https://covid.knoxcountytn.gov/case-count.html#covid_data">its guidelines</a>. For it to be green for the number of new cases, it requires "No three-day shifts of 1.5 standard deviations above a rolling mean (based on data from the previous 14 days)." It's not quite clear to me what this means (the average of the three days can't exceed this or **all** or **any** of the three days can't exceed it?);  I'm taking the interpretation that if the three day mean is above this value, there's a problem. They update their stop lights weekly; this looks at each day to see if the average of that day and the two previous days exceeds what seems to be their threshold. Remember that this is just me playing with the data -- they're the experts to decide if cases are growing enough to be worrisome.


GetZone <- function(cases) {
  if(length(cases[!is.na(cases)])<17) {
    return("black")
  }
  old.cases <- head(tail(cases,17),14)
  new.cases <- tail(cases,3)
  max.allowed.green <- mean(old.cases, na.rm=TRUE)+1.5*sd(old.cases, na.rm=TRUE)
  max.allowed.yellow <- mean(old.cases, na.rm=TRUE)+3*sd(old.cases, na.rm=TRUE)
  result <- "red"
  if(mean(new.cases, na.rm=TRUE)<max.allowed.yellow) {
    result <- "yellow"
  }
  if(mean(new.cases, na.rm=TRUE)<max.allowed.green) {
    result <- "green"
  }
  return(result)
}

daily3_knox <- data.frame(date=daily_knox$DATE[-(1:2)], avg=NA, col="darkgray", stringsAsFactors = FALSE)
for(i in sequence(nrow(daily3_knox))) {
  daily3_knox$avg[i] <- mean(daily_knox$NEW_CASES[i:(i+2)])
  daily3_knox$col[i] <- GetZone(head(daily_knox$NEW_CASES,i+2))
}

daily3_knox <- daily3_knox[!is.na(daily3_knox$avg),]
daily3_knox$col <- gsub("yellow", "yellow2", daily3_knox$col)
daily3_knox$col <- gsub("black", "darkgray", daily3_knox$col)

knox_new3 <- ggplot(daily3_knox, aes(x=date, y=avg)) + geom_smooth() + geom_point(shape=21, colour="black", fill=daily3_knox$col) + ylab("Three day average of new cases") + xlab("Date") + ylim(0,NA)
print(knox_new3)

```


```{r plotsB, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

# A question is whether testing is adequate. The White House has said about 30 tests per 1000 people per month is adequate (this is also what <a href="https://projects.propublica.org/reopening-america/#notes">ProPublica</a> uses); others have argued that around 45 tests per 1000 people per month is better, though with variation depending on infection rate (see <a href="https://www.statnews.com/2020/04/27/coronavirus-many-states-short-of-testing-levels-needed-for-safe-reopening/">here</a>). These are the black lines on the plots below (calculated as tests per day, given Knox County's population of `r knox_pop`, and assuming 30 days per month).


knox_testing <- ggplot(daily_knox[!is.na(daily_knox$NEW_TESTS),], aes(x=DATE, y=NEW_TESTS)) + geom_smooth() + geom_point() + ylab("Number of new tests in Knox each day") + xlab("Date") + ylim(0,NA)
knox_testing <- knox_testing + geom_hline(yintercept=(knox_pop*45/1000)/30, col="black") + geom_hline(yintercept=(knox_pop*30/1000)/30, col="black")
print(knox_testing)


```

<h2 id="testing">Testing</h2>

Testing is a key part of getting a handle on the pandemic. Here are Knox County, Oak Ridge's counties (Anderson and Roane), and all the East TN counties combined (the same ones used for regional hospital reporting for bed availability). This plots shows the daily number of tests per 100,000 residents. It also includes testing done by UT student health, using data compiled by Alex Zukowski (Zukowski, Taylor A. “University of Tennessee, Knoxville COVID-19 Dataset.” COVID-19 in The University of Tennessee, Knoxville, 2020, sites.google.com/view/utk-covid19/data). For the UT data, I am plotting against number of students (30,000).


```{r plotsB2, echo=FALSE, message=FALSE, warning=FALSE}

proportional_testing <- ggplot(daily_focal_no_ut[!is.na(daily_focal_no_ut$Tests_per_100k),], aes(x=DATE, y=Tests_per_100k, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Number of new tests per 100,000 people each day") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
print(proportional_testing)


```

Another way to look at testing (or disease spread) is to look at the proportion of positive tests ("positivity rate"): they can go up if a greater proportion of symptomatic people are being tested and/or if the frequency of the disease is increasing. Updated WHO guidelines recommend testing should be 5% positive or lower (black line). The lines show the seven day averages. UT's testing positivity rate (using student health data is so high it obscures the county data, so it is reported separately).


```{r plotsB3, echo=FALSE, message=FALSE, warning=FALSE}

# daily_knox$NEW_PROPORTION_CONFIRMED <- 100*daily_knox$NEW_CONFIRMED/daily_knox$NEW_TESTS
#
# knox_proportion_pos <- ggplot(daily_knox[!is.na(daily_knox$NEW_PROPORTION_CONFIRMED),], aes(x=DATE, y=NEW_PROPORTION_CONFIRMED)) + geom_smooth() + geom_point() + ylab("Percentage of positive tests in Knox each day") + xlab("Date") + ylim(0,NA) + geom_hline(yintercept=10, col="black")
# print(knox_proportion_pos)


daily_focal_no_ut$NEW_PROPORTION_CONFIRMED <- 100*daily_focal_no_ut$NEW_CONFIRMED/daily_focal_no_ut$NEW_TESTS

focal_proportion_pos <- ggplot(daily_focal_no_ut[!is.na(daily_focal_no_ut$NEW_PROPORTION_CONFIRMED),], aes(x=DATE, y=NEW_PROPORTION_CONFIRMED, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Percentage of positive tests in focal areas each day (7 day avg)") + xlab("Date") + geom_hline(yintercept=5, col="black") + scale_colour_viridis_d(end=0.8)
print(focal_proportion_pos)

#focal_proportion_pos_log1p <- ggplot(daily_focal[!is.na(daily_focal$NEW_PROPORTION_CONFIRMED),], aes(x=DATE, y=NEW_PROPORTION_CONFIRMED, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Percentage of positive tests in focal areas each day") + xlab("Date") + geom_hline(yintercept=5, col="black") + scale_colour_viridis_d(end=0.8) + scale_y_continuous(trans = "log1p", breaks = c(1, 5, 10, 25, 50, 100))
#print(focal_proportion_pos_log1p)

# par(mfcol=c(1,2))
# plot(knox$date, knox$confirmed, type="l")
# confirmed.ts <- ts(data=knox$confirmed, start=knox$date[1], end=knox$date[length(knox$date)])
# confirmed_plot <- confirmed.ts %>%
#   auto.arima() %>%
#   forecast(h=20) %>%
#   autoplot()
# print(confirmed_plot)

```

<hr />

<h2 id="schooling">Schooling</h2>

Many of the local schools are adopting a hybrid approach, where families can choose whether to send their kids to school or do online learning (sometimes with reduced options). The <i>New York Times</i> <a href="https://www.nytimes.com/2020/07/14/us/coronavirus-schools-fall.html">reports</a> on July 14, 2020, that, "As education leaders decide whether to reopen classrooms in the fall amid a raging pandemic, many are looking to a standard generally agreed upon among epidemiologists: To control community spread of the coronavirus, the average daily infection rate among those who are tested should not exceed 5 percent." Many districts nationally are not hitting that goal, but a question is whether local ones will. The first district to open in our area was Oak Ridge public schools, who had a start date for students in person on July 29, 2020. Following the procedure of the <i>NYT</i>'s article, I am plotting the seven day average of positivity rate for tests for the counties including Oak Ridge's counties (Roane and Anderson). The black line is the seven day rolling mean (total new confirmed / total new tests, not a mean of this ratio per day), the blue line is this smoothed, the dotted line is the 5% threshold, and the green rectangle is the goal and starts at the start of school -- the positivity should be in that rectangle to meet epidemiologists' goals. Oak Ridge is giving families options of whether to enroll their children in online or in person school: their plan, and the way to choose either mode, is <a href="https://www.ortn.edu/reopening-plan-2020-2021/">here</a>. They have updated their in person plan to require masks when possible but not social distancing; when individuals test positive, the possibly affected parts of the building will be closed for 2-5 days. We've opted for the online option for our family.

```{r oakridgesevendays, echo=FALSE, message=FALSE, warning=FALSE}
daily_oakridge2 <- subset(daily_focal, Region=="Anderson + Roane")
oakridge_seven <- data.frame(DATE=daily_oakridge2$DATE, new_confirmed=zoo::rollsum(daily_oakridge2$NEW_CONFIRMED, k=7, align="right", fill=NA), new_tests=zoo::rollsum(daily_oakridge2$NEW_TESTS, k=7, align="right", fill=NA), New_cases_per_100k=zoo::rollmean(daily_oakridge2$New_cases_per_100k, k=7, align="right", fill=NA))
oakridge_seven$positivity = 100*oakridge_seven$new_confirmed/oakridge_seven$new_tests

plot_oakridge_seven <- ggplot(oakridge_seven[!is.na(oakridge_seven$positivity),], aes(x=DATE, y=positivity)) + geom_rect(mapping=aes(xmin=as.POSIXct("2020/07/29"), xmax=as.POSIXct(Sys.Date()+7), ymin=0, ymax=5), fill="pale green") + geom_rect(mapping=aes(xmin=as.POSIXct("2020/07/29"), xmax=as.POSIXct(Sys.Date()+7), ymin=5, ymax=0.5+max(oakridge_seven$positivity,na.rm=TRUE)), fill="indianred1") + geom_line() + geom_smooth(se=FALSE) + ylab("Percentage of positive tests over seven days ending with date") + xlab("Date") + ylim(0,NA) + geom_hline(yintercept=5, col="black", lty="dotted")

print(plot_oakridge_seven)
```

Harvard’s Edmond J. Safra Center for Ethics and the Harvard Global Health Institute have created (July 19, 2020) <a href="https://globalhealth.harvard.edu/path-to-zero-schools-achieving-pandemic-resilient-teaching-and-learning-spaces/">guidelines for schools reopening</a> (see also their <a href="https://globalepidemics.org/wp-content/uploads/2020/07/pandemic_resilient_schools_briefing_7.19.20.pdf">full report PDF</a>). They distinguish students by age group: "With COVID-19, people 18 and younger have far lower risk of death, hospitalization, and severe outcomes and are also less likely to get infected. Within this group, students in the younger age band of 10 and under also transmit at lower rates. This last point about lower rates of transmission may also pertain to people 15 and younger, a point that research should clarify in coming weeks. Keeping levels of risk low for young children via pandemic resilient teaching and learning spaces is more readily  achievable than doing so for high school age students and the adult educators and staff in the school building." They provide suggestions on building ventilation, social distancing, and more, and mention the utility of looking at multiple metrics (such as positivity rate, hospitalization, and more), but focus on daily new cases per 100,000 people (with a caution about missing cases if testing is not adequate; for example, if positivity rate is above 10%). The plot below has summaries of their recommendations for priority for which grade levels can meet in person, **if there are conditions for pandemic resistant teaching and learning**. The black line is the rolling seven day average of new cases per day for the counties containing Oak Ridge (Roane and Anderson). Note that they recently (Dec. 18, 2020), released <a href="https://globalepidemics.org/2020/12/18/schools-and-the-path-to-zero/">new guidance</a> that suggest using in-school spread metrics rather than community metrics. I do not believe such metrics are available to the public for local schools.

```{r harvardstandards, echo=FALSE, message=FALSE, warning=FALSE, fig.height=13}
maxval <- max(30, max(oakridge_seven$New_cases_per_100k, na.rm=TRUE))
harvard_oakridge <- ggplot(oakridge_seven[!is.na(oakridge_seven$New_cases_per_100k),], aes(x=DATE, y=New_cases_per_100k)) + ylab("Average new cases per day per 100K population") + xlab("Date") + ylim(0,NA) +
  geom_rect(mapping=aes(xmin=min(oakridge_seven$DATE), xmax=max(oakridge_seven$DATE), ymin=0, ymax=1), fill="darkolivegreen1") +
  geom_rect(mapping=aes(xmin=min(oakridge_seven$DATE), xmax=max(oakridge_seven$DATE), ymin=1, ymax=10), fill="khaki1") +
  geom_rect(mapping=aes(xmin=min(oakridge_seven$DATE), xmax=max(oakridge_seven$DATE), ymin=10, ymax=25), fill="tan1") +
  geom_rect(mapping=aes(xmin=min(oakridge_seven$DATE), xmax=max(oakridge_seven$DATE), ymin=25, ymax=maxval), fill="indianred1") +
 annotate("text", x = min(oakridge_seven$DATE), y=c(0.5, 5.5, 17.5, mean(c(25, maxval))), label = c("", "First reopening priority: PreK-5 and special ed preK-8\nSecond reopening priority: 6-8 and special ed 9-12\nThird reopening priority: 9-12 on hybrid schedule", "First reopening priority: PreK-5 and special ed preK-8\nSecond reopening priority: 6-8 and special ed 9-12\nOnline only: 9-12", "All learning remote for everyone"), hjust=0) +
 geom_line()
print(harvard_oakridge)

```

Tennessee now breaks out covid test results for school age children (age 5-18). The number of tests in this age group and the underlying population size aren't known to me, so things like positivity rate and proportion of students infected cannot be determined, but the raw number of students infected can be shown (doing a seven day average):

```{r studentinfections, echo=FALSE, message=FALSE, warning=FALSE}
try(student_covid_total <- ggplot(schoolkids_daily, aes(x=DATE, y=CASE_COUNT, group=Region)) + geom_line(aes(colour=Region)) +  ylab("Total number of students who have tested positive") + xlab("Date") + scale_colour_viridis_d(end=0.8))
try(print(student_covid_total))

try(student_covid_daily <- ggplot(schoolkids_daily, aes(x=DATE, y=NEW_CASES, group=Region)) +  geom_ma(aes(colour=Region, linetype="a")) +  guides(linetype = FALSE) + ylab("Number of students with new positive covid results daily, 7 day avg") + xlab("Date") + scale_colour_viridis_d(end=0.8))
try(print(student_covid_daily))
```





```{r andersonstandards, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
#<a href="https://www.acs.ac/">Anderson County</a> had a school plan based on the percentage of the community actively infected with covid. Their schools open later than Oak Ridge schools, but it might be a useful indicator for community thinking. Note that Anderson's metric is based on the *number* of people with active covid (those with positive tests who are not yet recovered or deceased) and so it may be sensitive to the number of tests in a way that the positivity rate is not; in the areas between phases they use other information to make a determination, such as number of absences of students and teachers.

daily_focal$Active_cases_percent <- 100*daily_focal$Active_cases_per_100k/100000
daily_focal<-daily_focal[!is.na(daily_focal$Active_cases_percent),]
local_active_percent <- ggplot(daily_focal[!is.na(daily_focal$Active_cases_percent),], aes(x=DATE, y=Active_cases_percent, group=Region)) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=-0.2, ymax=0), color="light blue", fill=NA) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=0, ymax=.1), color="pale green", fill=NA) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=.1, ymax=.4), color="olivedrab3", fill=NA) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=.4, ymax=.5), color="olivedrab1", fill=NA) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=.5, ymax=.7), color="yellow", fill=NA) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=.7, ymax=.8), color="orange", fill=NA) +
geom_rect(mapping=aes(xmin=min(daily_focal$DATE), xmax=max(daily_focal$DATE), ymin=.8, ymax=1), color="red", fill=NA) +
annotate("text", x = min(daily_focal$DATE), y=c(-0.1, 0.25, 0.6, 0.9), label = c("Phase 0, all normal", "Phase 1, schools open and virtual option", "Phase 2, blended learning plan", "Phase 3, all schools closed, all students virtual"), hjust=0) +
 geom_line(aes(colour=Region)) + ylab("Percent of people with active covid infections") + xlab("Date") + ylim(-0.2,1) + scale_colour_viridis_d(end=0.9, option="A")
print(local_active_percent)
```


<hr />

<h2 id="hospitalization">Hospitalization</h2>


```{r hospitalcapacitydata, echo=FALSE, message=FALSE, warning=FALSE}


# covidServer <- get.rds("https://knxhx.richdataservices.com/rds")
# catalog <- getCatalog(covidServer, "kchd")
# products <- getDataProducts(catalog)
# dataProduct <- getDataProduct(catalog, "us_tn_kchd_capacity")
# { sink("/dev/null"); hospital_resources <- rds.select(dataProduct, autoPage =  TRUE)@records; sink(); }
# hospital_resources$label = NA
# hospital_resources$label[hospital_resources$resource_type==0] <- "All beds"
# hospital_resources$label[hospital_resources$resource_type==1] <- "ICU beds"
# hospital_resources$label[hospital_resources$resource_type==2] <- "Ventilators"
# hospital_resources$cnt_available <- as.numeric(as.character(hospital_resources$cnt_available))
# hospital_resources$cnt_capacity <- as.numeric(as.character(hospital_resources$cnt_capacity))
# hospital_resources$pct_used <- as.numeric(as.character(hospital_resources$pct_used))
# hospital_resources$pct_available <- as.numeric(as.character(hospital_resources$pct_available))

last_hospital_update <- hospital_knox$Date[1]
resources <- unique(hospital_knox$East.Region.Hospitals)
for (resource_index in sequence(length(resources))) {
  hospital_resources_subset <- subset(hospital_knox, East.Region.Hospitals==resources[resource_index])
  cnt_used_previous = hospital_resources_subset$Current.Census[1]
  for(row_index in sequence(nrow(hospital_resources_subset))) {
	  if(row_index>1) {
		if(hospital_resources_subset$Current.Census[row_index] != cnt_used_previous) {
		cnt_used_previous <- hospital_resources_subset$Current.Census[row_index]
		last_hospital_update <- max(last_hospital_update, hospital_resources_subset$Date[row_index])
		}
	  }
  }
}


# hospitalfiles <- list.files(path="/Users/bomeara/Dropbox/KnoxCovid", pattern="*bed*", full.names =TRUE)
# capacity.df <- data.frame()
# previoushospitaldata <- data.frame()
# current.capacity.df <- data.frame()
# for (i in seq_along(hospitalfiles)) {
#   actual_time <- anytime::anytime(stringr::str_extract(hospitalfiles[i], "\\d+_\\d+_\\d+_\\d+_\\d+_\\d+"))
#   hospitaldata <- read.csv(hospitalfiles[i], stringsAsFactors=FALSE)
#   hospitaldata$Current.Utilization <- as.numeric(gsub('%', '', hospitaldata$Current.Utilization))
#   hospitaldata$Resource <- hospitaldata$East.Region.Hospitals
#
#   if(i==1) {
#     previoushospitaldata <- hospitaldata
#     hospitaldata$Date <- actual_time
#     capacity.df <- hospitaldata
#   } else {
#     if(all(dim(hospitaldata)==dim(previoushospitaldata))) {
#       if(any(hospitaldata!=previoushospitaldata)) {
#         previoushospitaldata <- hospitaldata
#         hospitaldata$Date <- actual_time
#         capacity.df <- rbind(capacity.df, hospitaldata)
#       }
#     }
#   }
#   current.capacity.df <- hospitaldata
#   rownames(current.capacity.df) <- current.capacity.df$Resource
# }
```

As of the last time the data were updated (likely `r as.numeric(difftime(Sys.Date(), as.Date(last_hospital_update), units="days"))` days ago), regional hospitals had `r tail(subset(hospital_knox, East.Region.Hospitals=="ICU Beds")$Available,1)` ICU beds available of `r tail(subset(hospital_knox, East.Region.Hospitals=="ICU Beds")$Total.Capacity,1)` total (so was at `r 100-round(100*( as.numeric(tail(subset(hospital_knox, East.Region.Hospitals=="ICU Beds")$Available,1)) / as.numeric(tail(subset(hospital_knox, East.Region.Hospitals=="ICU Beds")$Total.Capacity,1))))` percent capacity), and `r tail(subset(hospital_knox, East.Region.Hospitals=="Ventilators")$Available,1)` available ventilators out of `r tail(subset(hospital_knox, East.Region.Hospitals=="Ventilators")$Total.Capacity,1)` total, (so was at `r 100-round(100*( as.numeric(tail(subset(hospital_knox, East.Region.Hospitals=="Ventilators")$Available,1)) / as.numeric(tail(subset(hospital_knox, East.Region.Hospitals=="Ventilators")$Total.Capacity,1))))` percent capacity). The hospitals overall had `r tail(subset(hospital_knox, East.Region.Hospitals=="All Hospital Beds")$Available,1)` beds available of `r tail(subset(hospital_knox, East.Region.Hospitals=="All Hospital Beds")$Total.Capacity,1)` total (so was at `r 100-round(100*( as.numeric(tail(subset(hospital_knox, East.Region.Hospitals=="All Hospital Beds")$Available,1)) / as.numeric(tail(subset(hospital_knox, East.Region.Hospitals=="All Hospital Beds")$Total.Capacity,1))))` percent capacity). This is based on 19 acute care hospitals in the East TN region; based on the `r length(counties_in_hospital_region)` counties these hospitals are in, these serve at least `r formatC(region_pop, format="d", big.mark=",")` people. When a line hits 100% (indicated in red), the local hospitals are theoretically full for that resource (for *all* patients, not just covid patients), though there is surge capacity on top of this. Note that these data are updated only weekly, so current conditions maybe be much better or worse than these plots show. Data on capacity from Knox County's dashboard, data on hospitalizations and testing over time from the state data.


```{r hospitalcapacityplot, echo=FALSE, message=FALSE, warning=FALSE}
try(hosp_plot <- ggplot(hospital_knox, aes(x=Date, y=Current.Utilization, group=East.Region.Hospitals)) + geom_line(aes(colour=East.Region.Hospitals)) +  ylab("Percent Utilization in East Tennessee Region") + xlab("Date") + ylim(0,100) + scale_colour_viridis_d(end=0.8) + geom_hline(yintercept=100, col="red"))
try(print(hosp_plot))

```

Trends in hospitalization of covid patients over time. The vertical dotted line shows the last day with updated capacity information from Knox County, when there were `r tail(subset(hospital_knox, East.Region.Hospitals=="ICU Beds")$Available,1)` ICU beds available (ignoring surge capacity) for people in the East Tennessee region. The seven day average is shown.

```{r plotsD, echo=FALSE, message=FALSE, warning=FALSE}


new_hospitalization <- ggplot(daily_focal[!is.na(daily_focal$NEW_HOSPITALIZED),], aes(x=DATE, y=NEW_HOSPITALIZED, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Number of new covid hospitalizations each day (7 day avg)") + xlab("Date") + ylim(0,NA)  + scale_colour_viridis_d(end=0.8) + geom_vline(xintercept=as.POSIXct(last_hospital_update), col="black", linetype="dotted") 
print(new_hospitalization)

# tn_daily_aggregate <- daily %>% group_by(DATE) %>% summarise(new_hosp = sum(NEW_HOSPITALIZED))
#
#
# tn_new_hospitalization <- ggplot(tn_daily_aggregate[!is.na(tn_daily_aggregate$new_hosp),], aes(x=DATE, y=new_hosp)) + geom_smooth() + geom_point() + ylab("Number of new covid hospitalizations in TN each day") + xlab("Date") + ylim(0,NA)
# print(tn_new_hospitalization)

# all_confirmed <- data.frame(date=c(us_aggregate$date, tn_aggregate$date, knox$date), percentconfirmed=c(us_aggregate$percentconfirmed, tn_aggregate$percentconfirmed, knox$percentconfirmed), region=c(rep("US", nrow(us_aggregate)),rep("TN", nrow(tn_aggregate)), rep("Knox", nrow(knox))))
# con <- ggplot(all_confirmed, aes(x=date, y=percentconfirmed, color=region)) + geom_smooth() + geom_point() + ylab("Percent of population with confirmed tests")
# print(con)
#
# three_weeks_ago <- tail(sort(unique(all_confirmed$date)),21)[1]
# all_confirmed_3 <- all_confirmed[all_confirmed$date>=three_weeks_ago,]
#
# con3 <- ggplot(all_confirmed_3, aes(x=date, y=percentconfirmed, color=region)) + geom_smooth() + geom_point() + ylab("Percent of population with confirmed tests")
# print(con3)
#
# diff_confirmed <-  data.frame(date=c(us_diff$date, tn_diff$date, knox_diff$date), daily_percent_confirmed=c(us_diff$daily_percent_confirmed, tn_diff$daily_percent_confirmed, knox_diff$daily_percent_confirmed), region=c(rep("US", nrow(us_diff)),rep("TN", nrow(tn_diff)), rep("Knox", nrow(knox_diff))))
# diffplot <- ggplot(diff_confirmed, aes(x=date, y=daily_percent_confirmed, color=region)) + geom_smooth(span=14/nrow(knox_diff)) + geom_point() + ylab("Percent of population new confirmed tests daily")
# print(diffplot)
#
#
# diff_confirmed_3 <- diff_confirmed[diff_confirmed$date>=three_weeks_ago,]
# diffplot3 <- ggplot(diff_confirmed_3, aes(x=date, y=daily_percent_confirmed, color=region)) + geom_smooth() + geom_point() + ylab("Percent of population new confirmed tests daily")
# print(diffplot3)

```

In December 2020, California instituted a new policy of going to shutdowns in regions when ICUs get filled above 85% capacity. When this happens, "Affected communities will be required to close personal service businesses, including hair and nail salons, playgrounds, zoos, museums, aquariums and wineries. Overnight, short-term stays at campgrounds would be prohibited. Restaurants will be required to return to take-out service only. Retail businesses will be limited to 20% of their customer capacity inside at any one time, with requirements for store officials to ensure there’s no indoor drinking or eating." according to an [article in the LA times](https://www.latimes.com/california/story/2020-12-03/newsom-weighs-shutdown-california-covid-19-cases-soar-december). Tennessee is not bound by California's rules, but we can plot our region's hospital capacity and see how the current outbreak compares. Blue shows California's threshold for shutting down many things like dining in restaurants; red shows full capacity for our region, when every bed is full (ignoring any surge capacity):

```{r hospitalcapacityplotvsCA, echo=FALSE, message=FALSE, warning=FALSE}
hospital_knox_ICU <- subset(hospital_knox, East.Region.Hospitals=="ICU Beds")
try(hosp_plot_CA <- ggplot(hospital_knox_ICU, aes(x=Date, y=Current.Utilization)) + geom_line() +  ylab("Percent of ICU beds filled") + xlab("Date") + scale_colour_viridis_d(end=0.8) + geom_hline(yintercept=85, col="dodgerblue") + geom_hline(yintercept=100, col="red"))
try(print(hosp_plot_CA))

```


```{r hhshospitalization, echo=FALSE, message=FALSE, warning=FALSE}

```


US Health and Human Services is now releasing data on hospital occupancy by hospital. For more, see <a href="https://healthdata.gov/dataset/covid-19-reported-patient-impact-and-hospital-capacity-facility">here</a>. I'm showing all the hospitals in east Tennessee that have at least a couple of updates in the HHS database (some tiny hospitals apparently rarely update this info). These data are for the week starting `r max(hhs_capacity_tn_focal$DATE)`. The first table is the capacity at various local hospitals, looking at just outpatient beds. These are weekly averages: there could be fluctuations over the week in bed occupancy and even in number of beds available, and they don't necessarily mean this is what one can expect at hospitals today. Perhaps the most striking is the "Adult ICU number avail": how many beds in the ICU were available, on average, over the week starting `r max(hhs_capacity_tn_focal$DATE)` at various local hospitals, which ranged from `r min(hhs_capacity_tn_focal_latest_pretty[,"Adult ICU number avail"])` to at most `r max(hhs_capacity_tn_focal_latest_pretty[,"Adult ICU number avail"])` beds. 

```{r hhstable, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
knitr::kable(hhs_capacity_tn_focal_latest_pretty)
```

These plots stack all the adult beds available in all regional hospitals, grouping by city.

```{r hhsfirstplot, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
hhs_plot2b <- ggplot(hhs_capacity_tn_focal_cities, aes(x=DATE, y=number_unoccupied_adult_hospital_inpatient_beds_sum, group=city, fill=city)) + geom_area() + ylab("Average total number of unoccupied adult inpatient beds\n(Higher is better)") + xlab("Start of collection week") + theme(legend.position="bottom") + theme(legend.text=element_text(size=8))
print(hhs_plot2b)

hhs_plot4b <- ggplot(hhs_capacity_tn_focal_cities, aes(x=DATE, y=number_unoccupied_adult_hospital_ICU_beds_sum, group=city, fill=city)) + geom_area() + ylab("Average total number of unoccupied adult ICU beds\n(Higher is better)") + xlab("Start of collection week") + theme(legend.position="bottom") + theme(legend.text=element_text(size=8))
print(hhs_plot4b)
```

There is also data on the individual hospitals. I'm showing the percentage of beds filled per hospital (higher is worse): all adult outpatient beds, then just the adult ICU beds.

```{r hhspart2, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, fig.height=7}

hhs_plot1 <- ggplot(hhs_capacity_tn_focal, aes(x=DATE, y=percentage_adult_hospital_inpatient_bed_occupied_of_all_inpatient_beds, group=hospital_name)) + geom_line() + ylab("Percentage of all adult inpatient beds occupied") + xlab("Start of collection week") + facet_wrap(facets=vars(hospital_name), ncol=2) + theme(plot.title = element_text(size=2)) + ylim(0,100)
print(hhs_plot1)



hhs_plot3 <- ggplot(hhs_capacity_tn_focal, aes(x=DATE, y=percentage_adult_hospital_inpatient_ICU_bed_occupied_of_all_inpatient_ICU_beds, group=hospital_name)) + geom_line() + ylab("Percentage of all adult ICU beds occupied") + xlab("Start of collection week") + facet_wrap(facets=vars(hospital_name), ncol=2)  + ylim(0,100)
print(hhs_plot3)



```

Finally, we can break out the percentage of patients in the beds (all adult outpatient and adult ICU) who have confirmed or suspected covid. That does not mean that covid is their primary reason (or reason at all) for being in the hospital, but can still suggest something about the pandemic, including something of the population of patients facing east Tennessee healthcare workers.

```{r hhspart3, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, fig.height=7}

hhs_plot2 <- ggplot(hhs_capacity_tn_focal, aes(x=DATE, y=percentage_adult_hospital_inpatient_bed_occupied_covid_confirmed_or_suspected_7_day_avg_of_all_occupied, group=hospital_name)) + geom_line() + ylab("Percentage of adult inpatient beds with confirmed and suspected covid") + xlab("Start of collection week") + facet_wrap(facets=vars(hospital_name), ncol=2)  + ylim(0,100)
print(hhs_plot2)


hhs_plot4 <- ggplot(hhs_capacity_tn_focal, aes(x=DATE, y=percentage_adult_hospital_inpatient_ICU_bed_occupied_of_all_inpatient_ICU_beds, group=hospital_name)) + geom_line() + ylab("Percentage of adult ICU beds with confirmed and suspected covid") + xlab("Start of collection week") + facet_wrap(facets=vars(hospital_name), ncol=2)  + ylim(0,100)
print(hhs_plot4)
```


<h2 id="vaccination">Vaccination</h2>

Tennessee releases information on demographics of individuals getting vaccinated. All terminology follows that used by the state, including terms like race and sex.

```{r vaccination1, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}





plot_race_covid_vaccination <- ggplot(race_vaccine, aes(x=DATE, y=VACCINE_COUNT, group=Race)) + geom_line(aes(colour=Race))+ xlab("Date") + ylab("Number of people with at least one vaccination")
print(plot_race_covid_vaccination)

plot_race_covid_vaccination_full <- ggplot(race_vaccine, aes(x=DATE, y=RECIP_FULLY_VACC, group=Race)) + geom_line(aes(colour=Race))+ xlab("Date") + ylab("Number of people fully vaccinated")
print(plot_race_covid_vaccination_full)

plot_ethnicity_covid_vaccination <- ggplot(ethnicity_vaccine, aes(x=DATE, y=VACCINE_COUNT, group=Ethnicity)) + geom_line(aes(colour=Ethnicity))+ xlab("Date") + ylab("Number of people with at least one vaccination")
print(plot_ethnicity_covid_vaccination)

plot_ethnicity_covid_vaccination_full <- ggplot(ethnicity_vaccine, aes(x=DATE, y=RECIP_FULLY_VACC, group=Ethnicity)) + geom_line(aes(colour=Ethnicity))+ xlab("Date") + ylab("Number of people fully vaccinated")
print(plot_ethnicity_covid_vaccination_full)

plot_sex_covid_vaccination <- ggplot(sex_vaccine, aes(x=DATE, y=VACCINE_COUNT, group=Sex)) + geom_line(aes(colour=Sex))+ xlab("Date") + ylab("Number of people with at least one vaccination")
print(plot_sex_covid_vaccination)

plot_sex_covid_vaccination_full <- ggplot(sex_vaccine, aes(x=DATE, y=RECIP_FULLY_VACC, group=Sex)) + geom_line(aes(colour=Sex))+ xlab("Date") + ylab("Number of people fully vaccinated")
print(plot_sex_covid_vaccination_full)
```


<hr />

<h2 id="demographics">Demographics</h2>

Tennessee releases information on demographics of individuals with covid. Age is broken out below, but here are other categories. All terminology follows that used by the state, including terms like race and sex (assumed to be binary by them). Information on the population in each category come from the <a href="https://www.census.gov/quickfacts/TN">US Census</a>. It appears that the categorization of "one or more races" vs "other/multiracial" differs radically between the US Census and TN's health stats (the census seems to put far fewer people into their category, so the proportions computed seem radically out of line: all other groups have 2-7% infection rate, for example, while this demographic has 40% infection rate if the denominator from the census is right for the numerator from the state). Because the data seem so different, and the scale obscures info for other groups, I am omitting that group here. Another major caveat in these data is potential unequal access to testing, which will lead to worse underestimates of covid incidence in for groups of people who can get tested less readily.

```{r demographics1, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# population_total <- 6829174

# population_female <- population_total*0.512
# population_male <- population_total*(1-0.512)

# population_white <- population_total*0.784
# population_black_africanamerican <- population_total*0.171
# population_asian <- population_total*0.02
# population_americanindian_alaskannative <- population_total*0.005
# population_nativehawaiian_other_pacificislander <- population_total*0.001
# population_twoormoreraces <- population_total*0.02

# population_hispanic <- population_total*0.057
# population_not_hispanic <- population_total*(1-0.057)


# population_age_under_5 <- population_total*0.06
# population_age_under_18 <- population_total*0.221
# population_age_65_and_over <- population_total*0.167



plot_race_covid_incidence <- ggplot(race, aes(x=Date, y=percent_of_demographic_with_cases, group=Race)) + geom_line(aes(colour=Race))+ xlab("Date") + scale_y_continuous(
    
    # Features of the first axis
    name = "Percentage who have had covid",
    
    # Add a second axis and specify its features
    sec.axis = dup_axis( labels=c("1/10", "1/20", "1/50", "1/100"), breaks=c(10, 5, 2, 1), name="Fraction who have had covid")
  ) 
print(plot_race_covid_incidence)

plot_race_covid_death <- ggplot(race, aes(x=Date, y=percent_of_demographic_dead, group=Race)) + geom_line(aes(colour=Race)) + xlab("Date")  + scale_y_continuous(
    
    # Features of the first axis
    name = "Percentage who have died from covid",
    
    # Add a second axis and specify its features
    sec.axis = dup_axis( labels=c("1/2000", "1/1500", "1/1000", "1/750"), breaks=c(100/2000, 100/1500, 100/1000, 100/750), name="Fraction who have died from covid")
  ) 
print(plot_race_covid_death)


plot_ethnicity_covid_incidence <- ggplot(ethnicity, aes(x=Date, y=percent_of_demographic_with_cases, group=Ethnicity)) + geom_line(aes(colour=Ethnicity))+ xlab("Date") + scale_y_continuous(
    
    # Features of the first axis
    name = "Percentage who have had covid",
    
    # Add a second axis and specify its features
    sec.axis = dup_axis( labels=c("1/10", "1/20", "1/50", "1/100"), breaks=c(10, 5, 2, 1), name="Fraction who have had covid")
  ) 
print(plot_ethnicity_covid_incidence)

plot_ethnicity_covid_death <- ggplot(ethnicity, aes(x=Date, y=percent_of_demographic_dead, group=Ethnicity)) + geom_line(aes(colour=Ethnicity)) + xlab("Date")  + scale_y_continuous(
    
    # Features of the first axis
    name = "Percentage who have died from covid",
    
    # Add a second axis and specify its features
    sec.axis = dup_axis( labels=c("1/2000", "1/1500", "1/1000", "1/750"), breaks=c(100/2000, 100/1500, 100/1000, 100/750), name="Fraction who have died from covid")
  ) 
print(plot_ethnicity_covid_death)


plot_sex_covid_incidence <- ggplot(sex, aes(x=Date, y=percent_of_demographic_with_cases, group=Sex)) + geom_line(aes(colour=Sex))+ xlab("Date") + scale_y_continuous(
    
    # Features of the first axis
    name = "Percentage who have had covid",
    
    # Add a second axis and specify its features
    sec.axis = dup_axis( labels=c("1/10", "1/20", "1/50", "1/100"), breaks=c(10, 5, 2, 1), name="Fraction who have had covid")
  ) 
print(plot_sex_covid_incidence)

plot_sex_covid_death <- ggplot(sex, aes(x=Date, y=percent_of_demographic_dead, group=Sex)) + geom_line(aes(colour=Sex)) + xlab("Date")  + scale_y_continuous(
    
    # Features of the first axis
    name = "Percentage who have died from covid",
    
    # Add a second axis and specify its features
    sec.axis = dup_axis( labels=c("1/2000", "1/1500", "1/1000", "1/750"), breaks=c(100/2000, 100/1500, 100/1000, 100/750), name="Fraction who have died from covid")
  ) 
print(plot_sex_covid_death)


```

<hr />

<h2 id="ages">Ages</h2>

Which age groups are being infected is an important question as local schools open up. These are data from Knox county alone. Note that one important bias here could be testing rate: if two year olds aren't being tested as often as forty year olds, the age 0-10 results will be lower than the actual rate of infection, for example.

```{r age, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# covidServer <- get.rds("https://knxhx.richdataservices.com/rds")
# catalog <- getCatalog(covidServer, "kcdh")
# products <- getDataProducts(catalog)
# dataProduct <- getDataProduct(catalog, "us_tn_kchd_age")
# { sink("/dev/null"); ages <- rds.select(dataProduct, autoPage =  TRUE)@records; sink(); }
# ages$Age <- as.character(ages$age_group)
# ages$age_group <- as.numeric(as.character(ages$age_group))
# ages$Age[(ages$age_group%%10==1)] <- paste(ages$age_group[(ages$age_group%%10==1)],"-",ages$age_group[(ages$age_group%%10==1)]+9, sep="")
# ages$Age[ages$age_group==0] <- "0-10"
# ages$Age[ages$age_group==99] <- "100+"
# ages$pct_confirmed <- as.numeric(as.character(ages$pct_confirmed))
#
# label_indices <- which(ages$date_stamp == min(ages$date_stamp) | ages$date_stamp == max(ages$date_stamp))
# labels <- rep("", nrow(ages))
# labels[label_indices] <- ages$Age[label_indices]
# ages$Label <- labels
#
# ageplot <- ggplot(ages, aes(x=date_stamp, y=pct_confirmed, group=Age)) + geom_line(aes(colour=Age)) + ylab("Cumulative percent of cases in each age group") + xlab("Date") + scale_colour_viridis_d(end=0.8) + geom_label_repel(aes(label = Label),na.rm = TRUE) + guides(colour = "none")
# print(ageplot)
```

```{r age2, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}


ageplot_knox_daily <- ggplot(subset(age_county, COUNTY=="Knox"), aes(x=DATE, y=PercentDaily, group=AGE_GROUP)) + geom_ma(aes(colour=AGE_GROUP, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Daily percentage of cases by age group in Knox County (7 day avg)") + xlab("Date") + scale_colour_brewer(type="qual", palette="Dark2")
ageplot_knox_cumulative <- ggplot(subset(age_county, COUNTY=="Knox"), aes(x=DATE, y=PercentCumulative, group=AGE_GROUP)) + geom_line(aes(colour=AGE_GROUP)) + ylab("Cumulative percentage of cases by age group in Knox County") + xlab("Date") + scale_colour_brewer(type="qual", palette="Dark2")
#ageplot_knox_both <- ggarrange(ageplot_knox_daily, #ageplot_knox_cumulative, labels=c("Daily", "Cumulative"), ncol=2, nrow=1)
print(ageplot_knox_daily)
print(ageplot_knox_cumulative)

```

<hr />

<h2 id="summarytable">Summary table</h2>

We can summarize all this information into a table showing the percentage of different populations who have gotten covid, died from covid, and been vaccinated against it to check for disparities. In many categories there is a substantial unknown, so the numbers in those areas might be low: for example, if 20% of the people being vaccinated have no race recorded, then adding up all the proportion of people in the race categories who are vaccinated will be lower than the total vaccinated. This is why, for example, the proportion of people with positive covid tests by race is lower than any grouping by sex: there are a lot more unknowns in the race category, and I don't want to assume that the distribution of the unknowns matches the distribution of knowns.  I am also treating as unknown categories that seem to have issues, such as mulitracial (very different count by the census than by the TN data) and other for sex in some data (gender is a spectrum, but the available data treat it as binary usually and call it sex; I follow this convention in the source data). 

```{r summarytabletn, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# I'm doing this poorly using hard coding, but I don't know of a better way
racesum <- data.frame(Category="Race", Group=c("American Indian or Alaska Native", "Asian", "Black or African American", "Native Hawaiian or Other Pacific Islander", "White"), Positive_Covid_Test=NA, Covid_Death=NA, At_Least_One_Vaccination=NA, Fully_Vaccinated=NA)
race_recent <- subset(race, Date==max(race$Date))
for (i in seq_along(racesum$Group)) {
	racesum$Positive_Covid_Test[i] <- race_recent$percent_of_demographic_with_cases[which(race_recent$CAT_DETAIL==racesum$Group[i])]
	racesum$Covid_Death[i] <- race_recent$percent_of_demographic_dead[which(race_recent$CAT_DETAIL==racesum$Group[i])]

}
race_vaccine_recent <- subset(race_vaccine, DATE==max(race_vaccine$DATE))

racesum[which(racesum$Group=="Asian"),]$At_Least_One_Vaccination <- 100*race_vaccine_recent[which(race_vaccine_recent$Race=="Asian"),]$RECIPIENT_COUNT / population_asian

racesum[which(racesum$Group=="Asian"),]$Fully_Vaccinated <- 100*race_vaccine_recent[which(race_vaccine_recent$Race=="Asian"),]$RECIP_FULLY_VACC / population_asian


racesum[which(racesum$Group=="Black or African American"),]$At_Least_One_Vaccination <- 100*race_vaccine_recent[which(race_vaccine_recent$Race=="Black Or African American"),]$RECIPIENT_COUNT / population_black_africanamerican

racesum[which(racesum$Group=="Black or African American"),]$Fully_Vaccinated <- 100*race_vaccine_recent[which(race_vaccine_recent$Race=="Black Or African American"),]$RECIP_FULLY_VACC / population_black_africanamerican


racesum[which(racesum$Group=="White"),]$At_Least_One_Vaccination <- 100*race_vaccine_recent[which(race_vaccine_recent$Race=="White"),]$RECIPIENT_COUNT / population_white

racesum[which(racesum$Group=="White"),]$Fully_Vaccinated <- 100*race_vaccine_recent[which(race_vaccine_recent$Race=="White"),]$RECIP_FULLY_VACC / population_white

sumtab <- racesum


ethnicitysum <- data.frame(Category="Ethnicity", Group=c("Hispanic", "Not Hispanic or Latino"), Positive_Covid_Test=NA, Covid_Death=NA, At_Least_One_Vaccination=NA, Fully_Vaccinated=NA)
ethnicity_recent <- subset(ethnicity, Date==max(ethnicity$Date))
for (i in seq_along(ethnicitysum$Group)) {
	ethnicitysum$Positive_Covid_Test[i] <- ethnicity_recent$percent_of_demographic_with_cases[which(ethnicity_recent$CAT_DETAIL==ethnicitysum$Group[i])]
	ethnicitysum$Covid_Death[i] <- ethnicity_recent$percent_of_demographic_dead[which(ethnicity_recent$CAT_DETAIL==ethnicitysum$Group[i])]

}
ethnicity_vaccine_recent <- subset(ethnicity_vaccine, DATE==max(ethnicity_vaccine$DATE))

ethnicitysum[which(ethnicitysum$Group=="Hispanic"),]$At_Least_One_Vaccination <- 100*ethnicity_vaccine_recent[which(ethnicity_vaccine_recent$Ethnicity=="Hispanic Or Latino"),]$RECIPIENT_COUNT / population_hispanic

ethnicitysum[which(ethnicitysum$Group=="Hispanic"),]$Fully_Vaccinated <- 100*ethnicity_vaccine_recent[which(ethnicity_vaccine_recent$Ethnicity=="Hispanic Or Latino"),]$RECIP_FULLY_VACC / population_hispanic


ethnicitysum[which(ethnicitysum$Group=="Not Hispanic or Latino"),]$At_Least_One_Vaccination <- 100*ethnicity_vaccine_recent[which(ethnicity_vaccine_recent$Ethnicity=="Not Hispanic Or Latino"),]$RECIPIENT_COUNT / population_not_hispanic

ethnicitysum[which(ethnicitysum$Group=="Not Hispanic or Latino"),]$Fully_Vaccinated <- 100*ethnicity_vaccine_recent[which(ethnicity_vaccine_recent$Ethnicity=="Not Hispanic Or Latino"),]$RECIP_FULLY_VACC / population_not_hispanic

sumtab <- rbind(sumtab, ethnicitysum)

sexsum <- data.frame(Category="Sex", Group=c("Female", "Male"), Positive_Covid_Test=NA, Covid_Death=NA, At_Least_One_Vaccination=NA, Fully_Vaccinated=NA)
sex_recent <- subset(sex, Date==max(sex$Date))
for (i in seq_along(sexsum$Group)) {
	sexsum$Positive_Covid_Test[i] <- sex_recent$percent_of_demographic_with_cases[which(sex_recent$CAT_DETAIL==sexsum$Group[i])]
	sexsum$Covid_Death[i] <- sex_recent$percent_of_demographic_dead[which(sex_recent$CAT_DETAIL==sexsum$Group[i])]

}
sex_vaccine_recent <- subset(sex_vaccine, DATE==max(sex_vaccine$DATE))

sexsum[which(sexsum$Group=="Female"),]$At_Least_One_Vaccination <- 100*sex_vaccine_recent[which(sex_vaccine_recent$Sex=="Female"),]$RECIPIENT_COUNT / population_female

sexsum[which(sexsum$Group=="Female"),]$Fully_Vaccinated <- 100*sex_vaccine_recent[which(sex_vaccine_recent$Sex=="Female"),]$RECIP_FULLY_VACC / population_female

sexsum[which(sexsum$Group=="Male"),]$At_Least_One_Vaccination <- 100*sex_vaccine_recent[which(sex_vaccine_recent$Sex=="Male"),]$RECIPIENT_COUNT / population_male

sexsum[which(sexsum$Group=="Male"),]$Fully_Vaccinated <- 100*sex_vaccine_recent[which(sex_vaccine_recent$Sex=="Male"),]$RECIP_FULLY_VACC / population_male

sumtab <- rbind(sumtab, sexsum)

sumtab[,3:6] <- round(sumtab[,3:6], 2)

knitr::kable(sumtab)

```

<hr />

<h2 id="ut">University of Tennessee, Knoxville</h2>

Another question is what is happening at UTK. There is official information available at https://www.utk.edu/coronavirus/guides/data-monitoring-and-contingency-options, of which I show one figure below. There are also reports in the news media, such as <a href="https://www.knoxnews.com/story/sports/college/university-of-tennessee/football/2020/08/17/tennessee-football-covid-19-cases-jeremy-pruitt-vols/5586379002/">this article from Aug. 18</a> showing that 23 of 91 football players (over 25%) have had positive covid tests since returning but before the start of classes. New York has <a href="https://www.nbcnewyork.com/news/local/alarming-indefensible-cuomo-ny-health-chief-blast-cdc-over-guidelines-change/2588146/">set a threshold of 100 cases or 5% positive tests</a> for colleges to move online; UT has had over that many active cases; its positivity rate is not officially public (as of now), though [this site](https://sites.google.com/view/utk-covid19) provides such information. The numbers of cases and tests have dramatically dropped recently at UT; one troubling suggestion for why is [reports of "pacts"](https://www.wvlt.tv/2020/09/15/covid-19-pacts-happening-among-ut-students/) by students not to get tested locally so as to avoid notifying the university. This violates the agreement students made before classes started and puts the local community, both on and off campus, at greater risk. UT is trying tests of sewage and saliva tests: upcoming saliva tests are scheduled at https://calendar.utk.edu/covid-19_testing. 

For a detailed look at UT, check out [https://sites.google.com/view/utk-covid19](https://sites.google.com/view/utk-covid19), for work done on an individual basis by a UTK student, Alex Zukowski. UT's official dashboard is at https://www.utk.edu/coronavirus/guides/data-monitoring-and-contingency-options/ but has less detail. I use the daily testing counts UT used to provide to Alex Zukowski as well as UT's weekly reports of the totals for that week. To convert to daily data, I divide the weekly reports by seven.

<iframe src="https://datastudio.google.com/embed/reporting/bb71d0fd-2817-4e14-9f84-7f74a1e503b5/page/Qr2ZB" width=600 height=300></iframe>

UT is now publishing results of saliva tests. ALL students residing in dorms, fraternities, or sororities have agreed to testing, but in some cases over half are missing mandatory testing. No sanctions have been announced yet. This table shows testing results of saliva tests:

<iframe width="600" height="225" src="https://datastudio.google.com/embed/reporting/dd6254bd-e3f4-4636-9fc8-3116bc64e033/page/auKkB" frameborder="0" style="border:0" allowfullscreen></iframe>


```{r utactive, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# cached downloads of https://veoci.com/veoci/p/form/4jmds5x4jj4j#tab=entryForm

utk_plot <- ggplot(utk.cases[!is.na(utk.cases$count),], aes(x=date, y=count, group=group)) + geom_line(aes(colour=group)) + ylab("Number of active cases at UTK") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8)
print(utk_plot)
```

```{r salivadata, echo=FALSE, message=FALSE, warning=FALSE}

```

Testing at UT is also a question. The plot below shows reported number of tests at the student health center, based on data aggregated by Alex Zukowski (see above). Note that these are the raw number of reported tests: a value of 20 means out of all 30,0000 UTK students, only 20 individuals were tested that day at the student health center. Not included here are athletes, who have much more frequent testing. 

 The dotted line on the plot shows the date of a [news story about covid pacts among students to avoid getting tested locally so they could avoid quarantine or isolation](https://www.wvlt.tv/2020/09/15/covid-19-pacts-happening-among-ut-students/). Spread by infected individuals matters, even if they personally are asymptomatic, so personal actions to avoid testing and quarantine / isolation can lead to disease spread to others who might not be so lucky, so it's very disappointing to hear of this. The drop in testing after that line may be purely coincidental, but it is a remarkable change in trend. Other universities test more intensely; for example, [U. of Illinois tests several thousand per day, not a few dozen](https://splunk-public.machinedata.illinois.edu/en-US/app/uofi_shield_public_APP/home). Not being an epidemiologist I do not want to weigh in on what strategy is optimal, but it is a remarkable contrast in approaches. UT is also starting to report on mandatory saliva-based testing, where they ask everyone residing in a dorm for a saliva sample, pool 3-5 individuals in a tube, test each tube, and then bring back individuals from pools that tested positive for individual testing. From `r paste(range(round(100*(1-saliva_data$Participation.rate),1)), collapse=" to ")` percent of the students listed as being in these dorms do not contribute samples.

```{r plotstestingut, echo=FALSE, message=FALSE, warning=FALSE}



ut_testing_plot <- ggplot(daily_utk[!is.na(daily_utk$NEW_TESTS),], aes(x=DATE, y=NEW_TESTS, group=Data_source)) + geom_line(aes(colour=Data_source)) + guides(linetype = FALSE) + ylab("Actual number of new tests in student health center each day") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8) + geom_vline(xintercept=as.Date("2020-09-15"), color="black", lty="dotted") + scale_x_date(limits=as.Date(range(c(daily_utk$DATE[!is.na(daily_utk$TOTAL_TESTS)], as.POSIXct(Sys.Date()))))) 
print(ut_testing_plot)

```

As for the county data, the positivity rate can also be important: if all the tests show up positive, likey symptomatic, cases, then there are likely other people being missed. The <i>New York Times</i> <a href="https://www.nytimes.com/2020/07/14/us/coronavirus-schools-fall.html">reports</a> on July 14, 2020, that, "As education leaders decide whether to reopen classrooms in the fall amid a raging pandemic, many are looking to a standard generally agreed upon among epidemiologists: To control community spread of the coronavirus, the average daily infection rate among those who are tested should not exceed 5 percent." The horizontal black line below shows that guidance. The CDC provides thoughts about possible testing strategies at colleges and universities [here](https://www.cdc.gov/coronavirus/2019-ncov/community/colleges-universities/ihe-testing.html#when-to-test) but not a firm number for how much testing they believe is necessary.


```{r plotsutkproportion, echo=FALSE, message=FALSE, warning=FALSE}



#focal_proportion_pos_utk <- ggplot(daily_utk[!is.na(daily_utk$NEW_PROPORTION_CONFIRMED),], aes(x=DATE, y=NEW_PROPORTION_CONFIRMED, group=Region)) + geom_ma(aes(colour=Region, linetype="a"), n=7) + guides(linetype = FALSE) + ylab("Percentage of positive tests in student center (7 day avg)") + xlab("Date") + geom_hline(yintercept=5, col="black") + scale_colour_viridis_d(end=0.8) + ylim(0,NA) + scale_x_date(limits=as.Date(range(c(daily_utk$DATE[!is.na(daily_utk$TOTAL_TESTS)], as.POSIXct(Sys.Date())))))
focal_proportion_pos_utk <- ggplot(daily_utk[!is.na(daily_utk$NEW_PROPORTION_CONFIRMED),], aes(x=DATE, y=NEW_PROPORTION_CONFIRMED, group=Region)) + geom_line(aes(colour=Data_source)) + guides(linetype = FALSE) + ylab("Percentage of positive tests in student center") + xlab("Date") + geom_hline(yintercept=5, col="black") + scale_colour_viridis_d(end=0.8) + ylim(0,NA) + scale_x_date(limits=as.Date(range(c(daily_utk$DATE[!is.na(daily_utk$TOTAL_TESTS)], as.POSIXct(Sys.Date())))))
print(focal_proportion_pos_utk)
```


We can also use the UTK saliva data to estimate the number of new cases: the proportion of students who ultimately test postive out of those tested by the saliva scans. Given poor compliance, the true proportions may be much higher than this (if students want to endanger others by not isolating, they may avoid testing if they think they have been exposed). Depending on the date of the test, between `r paste(paste("1 of every ", range(round(1/(saliva_data$Positive.diagnostic.tests./saliva_data$Samples))), sep=""), collapse=" to ")` of students who contributed samples had active covid infections. 


At the date of the most recent set of samples, from `r as.character(max(saliva_data$DATE))`, UTK reported <b>`r utk_reported_zukowski$CASES_ACTIVE[utk_reported_zukowski$DATE %in% as.character(max(saliva_data$DATE))]` active cases overall</b> (this presumably includes the `r saliva_data$Positive.diagnostic.tests.[nrow(saliva_data)]` positive diagnostic tests from the sampling). If the pool of students from this sample, which has a participation rate of `r round(100*(saliva_data$Participation.rate[nrow(saliva_data)]),1)` percent, is representative of the 30,000 person student body as a whole, that would mean there would be <b>`r round(saliva_data$Active_cases_per_30k[nrow(saliva_data)])` actual active cases</b> among the students on that date. 


I am converting the saliva test info to new cases per 100K to correspond with the [Harvard Global Health Institute's](https://globalepidemics.org/key-metrics-for-covid-suppression/) standards for guidance of control (yellow is community spread; red is the highest risk possible in their guidance -- for a county, that would mean "stay-at-home orders necessary" according to them, though how that translates into actions on a college campus is different). These guidelines are for daily new cases but the saliva data are active cases at a point in time. I am adopting the assumption that Knox County uses that new cases are only active for 14 days, so I'm computing the new case estimate as 1/14 the active case estimate. The green, yellow, and orange bands are the same as for Knox and Anderson+Roane counties above; the red band looks much thicker because it has the same lower bound as the others but no maximum, and some of the estimates for UTK are outside the range for the county-wide data. I include the 95% confidence interval for the estimate of new cases per 100,000 people, though this is an underestimate of the uncertainty (are dorms good random samples or are results clustered, are students who refuse testing similar to those who get tested, etc.).


```{r plotsaliva100k, echo=FALSE, message=FALSE, warning=FALSE}
saliva_plot <- ggplot(saliva_data, aes(x=DATE, y=New_cases_per_100k)) + 
geom_rect(mapping=aes(xmin=min(DATE), xmax=Sys.Date(), ymin=0, ymax=1), fill="darkolivegreen1") +
  geom_rect(mapping=aes(xmin=min(DATE), xmax=Sys.Date(), ymin=1, ymax=10), fill="khaki1") +
  geom_rect(mapping=aes(xmin=min(DATE), xmax=Sys.Date(), ymin=10, ymax=25), fill="tan1") +
  geom_rect(mapping=aes(xmin=min(DATE), xmax=Sys.Date(), ymin=25, ymax=max(New_cases_per_100k_upper)), fill="indianred1") + 
geom_point() + ylab("Est. daily new cases 100,000 people based on UTK saliva samples") + xlab("Date") + ylim(0,NA) + scale_colour_viridis_d(end=0.8) + geom_errorbar(aes(ymin=New_cases_per_100k_lower, ymax=New_cases_per_100k_upper), width=0.1) 
print(saliva_plot)
```




```{r plotutactiveproportion, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
#A different way to consider this is what percent of the community has active covid infections at any one time. There are two ways to get this. One is assuming that every person who has active covid 1) knows this through testing and 2) reports this to UT. This uses the active case numbers reported by UT (gotten through the intermediary of Alex Zukowski). The other way is to assume that the random saliva testing at the dorms is a better way to get this estimate. This avoids issues of asymptomatic or presymptomatic individuals not getting tested, but it could be biased in other ways: maybe the ~25% of students who skip mandatory testing are more likely to have covid (or maybe they're studying at home and not using the dorm at all), maybe the dorms selected are selected based on the results of sewage testing for covid, etc. My guess is that the saliva testing is the better estimate.

utk_active_proportion_df <- rbind(
	data.frame(DATE=as.Date(utk_reported_zukowski$DATE), Active_percentage=100*utk_reported_zukowski$CASES_ACTIVE/30000, Assumption="Every active case knows and reports"),
	data.frame(DATE=as.Date(saliva_data$DATE), Active_percentage=100*saliva_data$Positive.diagnostic.tests. / saliva_data$Samples, Assumption="Student saliva testing is representative")
)
utk_active_proportion_plot <- ggplot(utk_active_proportion_df, aes(x=DATE, y=Active_percentage, group=Assumption)) + geom_line(aes(colour=Assumption)) + scale_colour_viridis_d(end=0.8) 
print(utk_active_proportion_plot)


saliva_active <- round(saliva_data$Active_cases_per_30k[nrow(saliva_data)])
reported_active <- round(utk_reported_zukowski$CASES_ACTIVE[utk_reported_zukowski$DATE %in% as.character(max(saliva_data$DATE))])
reported_isolation_total <- round(utk_reported_zukowski$SELF_ISOLATED_TOTAL[utk_reported_zukowski$DATE %in% as.character(max(saliva_data$DATE))])

max_spreader_proportion <- (saliva_active-reported_active)/30000
min_spreader_proportion <- (max(0,saliva_active-reported_isolation_total))/30000
group_sizes <- seq(from=1, to=100, by=1)
avoidance_df <- rbind(
	data.frame(Group_size = group_sizes, Percentage_infected_groups=100*(1-dbinom(0, size=group_sizes, prob=min_spreader_proportion)), Assumption="Everyone self-isolating has covid"),
	data.frame(Group_size = group_sizes, Percentage_infected_groups=100*(1-dbinom(0, size=group_sizes, prob=max_spreader_proportion)), Assumption="Minimal self isolation of infected individuals")
)
```



```{r plotencounterprob, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

#Given the estimated percentage of individuals with active cases, what is the chance that in a given group of people at UT, there is someone there with covid? This is hard to know, as people with active cases who know about them are hopefully isolating themselves, and others are isolating who have been exposed and who may have active cases but do not know that yet. If we assume that the saliva samples are the best estimates of proportion of active cases (since it does not rely on students deciding to go to student health due to symptoms), we can use that to estimate the true number of active cases. We can then compare that to the number of people isolating due to active cases to figure out how many active cases are not in the self-reported situation. They could still be isolating because they have close contacts who are isolating, or they might not, so we can use both those assumptions. For example, on the last date of saliva samples, `r as.character(max(saliva_data$DATE))`, there were `r reported_active` individuals at UT with active reported covid infections, `r reported_isolation_total` individuals isolating (including presumably all the reported active cases), but based on the saliva proportion of active cases there would be `r saliva_active` active cases across the 30,000 students. The point estimate of the number of people who may be active and not in isolation may be between `r max(0,saliva_active-reported_isolation_total)` and `r saliva_active-reported_active` individuals, depending on how many of the ones who are active but don't know it are self isolating anyway. Remember that all these numbers are very uncertain, especially those based on small sample sizes, but we can use this to get a gut sense of the probability of encountering someone who actively has covid in different group sizes -- perhaps important for showing the importance of avoiding large unmasked groups, especially before returning home to family over the winter break. For example, for a thirty person party some weekend, there is between a `r round(min(subset(avoidance_df, Group_size==50)$Percentage_infected_groups))` to `r round(max(subset(avoidance_df, Group_size==50)$Percentage_infected_groups))`% chance that at least one person at that party actively has covid during the party (the lower estimate assumes that *every* person in isolation, whether they know it or not, is one of the people with active covid, but that still leaves many to continue spreading it (and people outside UT's campus also have covid, too)). Even repeated small group interactions pose a risk. If someone does not have covid, and repeatedly meets with random groups of three other people who might have it, there is only a `r min(round(subset(avoidance_df, Group_size==3)$Percentage_infected_groups,1))`% chance of someone else in each group having covid, but by the time the person has met with five such groups there is a `r round(100 * ( 1 - dbinom(0, 5, 0.01*min(round(subset(avoidance_df, Group_size==3)$Percentage_infected_groups,1)))))`% chance that the person will have been exposed to someone with covid in at least one of these groups.

utk_active_spreader_plot <- ggplot(avoidance_df, aes(x=Group_size, y=Percentage_infected_groups, group=Assumption)) + geom_line(aes(colour=Assumption)) + scale_colour_viridis_d(end=0.8)
print(utk_active_spreader_plot)


```

<hr />

<h2 id="webcams">Local webcams</h2>

<a href="https://therock.utk.edu/livestream/">UT's webcam of the Rock</a>, a campus landmark, to see how UT's community is choosing to protect others. You will have to click to start the stream. Some members of the community engage in hate speech on the Rock -- it is often quickly replaced by more positive messages, but it may be present on the Rock temporarily. 

<iframe src="https://therock.utk.edu/livestream/"  width=600 height=600 scrolling="no"></iframe>
